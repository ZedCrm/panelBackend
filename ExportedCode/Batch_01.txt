===== FILE: API\Attributes\RequirePermissionAttribute.cs =====
using Microsoft.AspNetCore.Mvc;

namespace API.Attributes
{
    [AttributeUsage(AttributeTargets.Class | AttributeTargets.Method)]
    public class RequirePermissionAttribute : Attribute
    {
        public string Permission { get; }
        public RequirePermissionAttribute(string permission)
        {
            Permission = permission;
        }
    }
}dddd

===== FILE: API\Controllers\bases\AuthController.cs =====
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Threading.Tasks;
using App.Contracts.Object.Base.auth;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using MyFrameWork.AppTool;

namespace API.Controllers.bases
{

    [ApiController]
    [Route("api/[controller]")]
    public class AuthController : ControllerBase
    {
        private readonly IAuthApp _authApp;

        public AuthController(IAuthApp authApp)
        {
            _authApp = authApp;
        }

        [HttpPost("login")]
        public async Task<ActionResult<OPTResult<AuthResponseDto>>> Login([FromBody] LoginRequestDto request)
        {
            var result = await _authApp.LoginAsync(request);
            if (result.IsSucceeded == false)
                return BadRequest(result);

            return Ok(result);
        }

        [HttpPost("register")]
        public async Task<IActionResult> Register(RegisterRequestDto dto)
        {
            var result = await _authApp.RegisterAsync(dto);
            if (result.IsSucceeded == false)
                return BadRequest(result.Message);
            return Ok(result.Data);
        }
    }
}

===== FILE: API\Controllers\bases\UserController.cs =====
// API\Controllers\bases\UserController.cs
using API.Attributes;
using App.Contracts.Object.Base.Users;
using Microsoft.AspNetCore.Mvc;
using MyFrameWork.AppTool;

namespace API.Controllers.bases
{
    [ApiController]
    [Route("api/[controller]")]
    public class UserController : BaseController
    {
        private readonly IUsersApp _usersApp;
        public UserController(IUsersApp usersApp) => _usersApp = usersApp;

        /*======================================================*/
        /*                     Ù…ØªØ¯Ù‡Ø§ÛŒ CRUD                      */
        /*======================================================*/
        [RequirePermission("User.View")]
        [HttpPost("/api/User/GetAll")]
        public async Task<ActionResult<ApiResult<List<UsersView>>>> GetAll([FromBody] Pagination pagination)
            => await _usersApp.GetAll(pagination);

        [RequirePermission("User.View")]
        [HttpGet("/api/User/GetById")]
        public async Task<ActionResult<ApiResult<UsersUpdate>>> GetById([FromQuery] int id)
            => await _usersApp.GetById(id);

        [RequirePermission("User.Create")]
        [HttpPost("/api/User/create")]
        public async Task<ActionResult<ApiResult>> Create([FromForm] UsersCreat userCreate)
            => await _usersApp.Create(userCreate);

        [RequirePermission("User.Edit")]
        [HttpPost("/api/User/update")]
        public async Task<ActionResult<ApiResult>> Update([FromForm] UsersUpdate userUpdate)
            => await _usersApp.Update(userUpdate);

        [RequirePermission("User.Delete")]
        [HttpPost("/api/User/delete")]
        public async Task<ActionResult<ApiResult>> Delete([FromBody] List<int> ids)
            => await _usersApp.DeleteBy(ids);

        /*======================================================*/
        /*                  Ù…ØªØ¯Ù‡Ø§ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ                      */
        /*======================================================*/
        [HttpPost("/api/User/keepalive")]
        public async Task<ActionResult<ApiResult>> KeepAlive()
        {
            var userId = GetCurrentUserId();
            if (userId <= 0)
                return Unauthorized(ApiResult.Failed("Ú©Ø§Ø±Ø¨Ø± Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.", 401));

            return await _usersApp.KeepAlive(userId);
        }

        [RequirePermission("User.Create")]
        [HttpGet("/api/user/getcreateform")]
        public async Task<ActionResult<ApiResult<UserCreateFormData>>> GetCreateForm()
            => await _usersApp.CreateForm();
    }
}

===== FILE: API\Controllers\Shop\CountTypeController.cs =====
using App.Contracts.Object.Shop.CountTypeCon;
using Microsoft.AspNetCore.Mvc;
using MyFrameWork.AppTool;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace API.Controllers.Shop
{
    public class CountTypeController : BaseController
    {
        private readonly ICountTypeApp _countTypeApp;

        public CountTypeController(ICountTypeApp countTypeApp)
        {
            _countTypeApp = countTypeApp;
        }

        [HttpPost("/api/CountType/GetAll")]
        public async Task<ActionResult<ApiResult<List<CountTypeView>>>> Index([FromBody] Pagination pagination)
        {
            return await _countTypeApp.GetAll(pagination);
        }

        [HttpGet("/api/CountType/GetById")]
        public async Task<ActionResult<ApiResult<CountTypeView>>> GetById([FromQuery] int id)
        {
            return await _countTypeApp.GetById(id);
        }

        [HttpPost("/api/CountType/create")]
        public async Task<ActionResult<ApiResult>> Create([FromBody] CountTypeCreate dto)
        {
            return await _countTypeApp.Create(dto);
        }

        [HttpPost("/api/CountType/delete")]
        public async Task<ActionResult<ApiResult>> Delete([FromBody] List<int> ids)
        {
            return await _countTypeApp.DeleteBy(ids);
        }

        [HttpDelete("/api/CountType/deletebyid")]
        public async Task<ActionResult<ApiResult>> DeleteById([FromQuery] int id)
        {
            return await _countTypeApp.DeleteBy(new List<int> { id });
        }

        [HttpPost("/api/CountType/update")]
        public async Task<ActionResult<ApiResult>> Update([FromBody] CountTypeView dto)
        {
            return await _countTypeApp.Update(dto);
        }

        [HttpGet("/api/counttype/CountTypelist")]
        public async Task<ActionResult<ApiResult<List<CountTypeView>>>> CountTypeList()
        {
            var pagination = new Pagination { PageNumber = 1, PageSize = 1000 };
            return await _countTypeApp.GetAll(pagination);
        }
    }
}

===== FILE: API\Controllers\Shop\InvController.cs =====
using System;
using System.Collections.Generic;
using API.Attributes;
using App.Contracts.Object.Shop.InvCon;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using MyFrameWork.AppTool;

namespace API.Controllers.Shop
{
    [Route("[controller]")]
    [Authorize]
    public class InvController : BaseController
    {
        private readonly IInvApp _invApp;
        public InvController(IInvApp invApp)
        {
            _invApp = invApp;
        }

        [HttpPost("/api/inv/GetAll")]
        [RequirePermission("ViewProduct")]
        public async Task<ActionResult<ApiResult<List<InvView>>>> Index([FromBody] Pagination pagination)
        {
            return await _invApp.GetAll(pagination);
        }

        [HttpGet("/api/inv/GetById")]
        [RequirePermission("InvView")]
        public async Task<ActionResult<ApiResult<InvUpdate>>> GetById([FromQuery] int id)
        {
            return await _invApp.GetById(id);
        }

        [HttpPost("/api/inv/create")]
        public async Task<ActionResult<ApiResult>> Create([FromBody] InvCreate invCreate)
        {
            return await _invApp.Create(invCreate);
        }

        [HttpPost("/api/inv/delete")]
        public async Task<ActionResult<ApiResult>> Delete([FromBody] List<int> ids)
        {
            return await _invApp.DeleteBy(ids);
        }

        [HttpDelete("/api/inv/deletebyid")]
        public async Task<ActionResult<ApiResult>> DeleteById([FromQuery] int id)
        {
            // Ù…ØªØ¯ DeleteBy Ù„ÛŒØ³ØªÛŒ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯Ø› ÛŒÚ© Ø¢ÛŒâ€ŒØ¯ÛŒ Ø±Ø§ Ù‡Ù… Ø¨Ù‡ ØµÙˆØ±Øª Ù„ÛŒØ³Øª Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            return await _invApp.DeleteBy(new List<int> { id });
        }

        [HttpPost("/api/inv/update")]
        public async Task<ActionResult<ApiResult>> Update([FromBody] InvUpdate invUpdate)
        {
            return await _invApp.Update(invUpdate);
        }
    }
}

===== FILE: API\Controllers\Shop\ProductController.cs =====
using API.Attributes;
using App.Contracts.Object.Shop.ProductCon;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using MyFrameWork.AppTool;

namespace API.Controllers.Shop
{
    /// <summary>
    /// کنترلر مربوط به مدیریت محصولات در سیستم
    /// </summary>
    [Authorize]
    public class ProductController : BaseController
    {
        private readonly IProductApp _productApp;

        public ProductController(IProductApp productApp)
        {
            _productApp = productApp;
        }

        /// <summary>
        /// دریافت لیست محصولات با صفحه‌بندی
        /// </summary>
        [RequirePermission("ViewProduct")]
        [HttpPost("/api/product/GetAll")]
        public async Task<ActionResult<ApiResult<List<ProductView>>>> Index([FromBody] Pagination pagination)
        {
            return await _productApp.GetAll(pagination);
        }

        /// <summary>
        /// جستجوی محصولات بر اساس معیارهای مشخص
        /// </summary>
        [HttpPost("/api/product/search")]
        public async Task<ActionResult<ApiResult<List<ProductView>>>> Search([FromBody] ProductSearchCriteria productSearch)
        {
            return await _productApp.SearchProducts(productSearch);
        }

        /// <summary>
        /// ایجاد محصول جدید
        /// </summary>
        [HttpPost("/api/product/create")]
        public async Task<ActionResult<ApiResult>> Create([FromBody] ProductCreate product)
        {
            return await _productApp.Create(product);
        }

        /// <summary>
        /// حذف محصولات بر اساس لیست آیدی‌ها
        /// </summary>
        [HttpPost("/api/product/delete")]
        public async Task<ActionResult<ApiResult>> Delete([FromBody] List<int> ids)
        {
            return await _productApp.DeleteBy(ids);
        }

        /// <summary>
        /// دریافت اطلاعات یک محصول بر اساس آیدی
        /// </summary>
        [HttpGet("/api/product/GetById")]
        public async Task<ActionResult<ApiResult<ProductUpdate>>> GetById([FromQuery] int id)
        {
            return await _productApp.GetById(id);
        }

        /// <summary>
        /// به‌روزرسانی اطلاعات محصول
        /// </summary>
        [HttpPost("/api/product/update")]
        public async Task<ActionResult<ApiResult>> Update([FromBody] ProductUpdate product)
        {
            return await _productApp.Update(product);
        }
    }
}

===== FILE: API\Controllers\BaseController.cs =====
using System.Security.Claims;
using Microsoft.AspNetCore.Mvc;

namespace API.Controllers
{

    [ApiController]
    public class BaseController : ControllerBase
    {
        protected int GetCurrentUserId()
        {
            var userIdClaim = User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier);
            if (userIdClaim == null || !int.TryParse(userIdClaim.Value, out int userId))
            {
                throw new UnauthorizedAccessException("User ID not found in token.");
            }
            return userId;
        }
    }
}


===== FILE: API\Controllers\MetadataController.cs =====
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Reflection;
using Microsoft.AspNetCore.Mvc;
using MyFrameWork.AppTool;

namespace API.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class MetadataController : ControllerBase
    {
        [HttpGet("GetModelMetadata/{modelName}")]
        public IActionResult GetModelMetadata(string modelName)
        {
            var assembly = Assembly.Load("App.Contracts");

            var type = assembly.GetTypes()
                .FirstOrDefault(t =>
                    t.IsClass &&
                    t.Namespace != null &&
                    t.Namespace.StartsWith("App.Contracts") &&
                    t.Name.Equals(modelName, StringComparison.OrdinalIgnoreCase));

            if (type == null)
                return NotFound($"Model '{modelName}' not found.");

            var propertyMetadata = new List<object>();

            foreach (var prop in type.GetProperties())
            {
                var displayAttr = prop.GetCustomAttribute<DisplayAttribute>();
                var requiredAttr = prop.GetCustomAttribute<RequiredAttribute>();
                var stringLengthAttr = prop.GetCustomAttribute<StringLengthAttribute>();
                var minLengthAttr = prop.GetCustomAttribute<MinLengthAttribute>();
                var maxLengthAttr = prop.GetCustomAttribute<MaxLengthAttribute>();
                var selectSourceAttr = prop.GetCustomAttribute<SelectSourceAttribute>();

                var inputType = prop.PropertyType == typeof(bool) ? "boolean" :
                                prop.PropertyType == typeof(int) || prop.PropertyType == typeof(long) ? "number" :
                                "text";

                var metadata = new
                {
                    name = ToCamelCase(prop.Name),
                    displayName = displayAttr?.Name ?? prop.Name,
                    inputType,
                    controlType = selectSourceAttr != null ? "select" : null,
                    selectSource = selectSourceAttr?.SourceName,
                    required = requiredAttr != null,
                    maxLength = maxLengthAttr?.Length ?? stringLengthAttr?.MaximumLength,
                    minLength = minLengthAttr?.Length ?? stringLengthAttr?.MinimumLength
                };

                propertyMetadata.Add(metadata);
            }

            return Ok(new Dictionary<string, List<object>> { { type.Name, propertyMetadata } });
        }

        private static string ToCamelCase(string input)
        {
            if (string.IsNullOrEmpty(input) || char.IsLower(input[0]))
                return input;

            return char.ToLower(input[0]) + input.Substring(1);
        }
    }
}


===== FILE: API\Middleware\TokenValidationMiddleware.cs =====
using API.Attributes;
using App.Contracts.Object.Base.auth;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging;
using System.Security.Claims;
using System.Threading.Tasks;

namespace API.Middleware
{
    public class TokenValidationMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<TokenValidationMiddleware> _logger;

        public TokenValidationMiddleware(RequestDelegate next, ILogger<TokenValidationMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

  public async Task InvokeAsync(HttpContext context, IPermissionService permissionService)
{
    var endpoint = context.GetEndpoint();
    var authorizeAttribute = endpoint?.Metadata.GetMetadata<Microsoft.AspNetCore.Authorization.AuthorizeAttribute>();

    // Ø§Ú¯Ø± Ø§Ú©Ø´Ù† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù„Ø§Ú¯ÛŒÙ† Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù‡
    if (authorizeAttribute == null)
    {
        await _next(context);
        return;
    }

    // 1. Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
    if (!context.User.Identity?.IsAuthenticated ?? true)
    {
        context.Response.StatusCode = 401;
        await context.Response.WriteAsync("Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²: ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±.");
        return;
    }

    // 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ userId
    var userIdClaim = context.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    if (!int.TryParse(userIdClaim, out int userId))
    {
        context.Response.StatusCode = 401;
        await context.Response.WriteAsync("ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±: Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.");
        return;
    }

    context.Items["UserId"] = userId;

    // 3. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾Ø±Ù…ÛŒØ´Ù† Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø§Ø² Attribute Ø³ÙØ§Ø±Ø´ÛŒ
    var requirePermissionAttribute = endpoint?.Metadata.GetMetadata<RequirePermissionAttribute>();
    if (requirePermissionAttribute != null)
    {
        bool hasPermission = await permissionService.HasPermissionAsync(userId, requirePermissionAttribute.Permission);
        if (!hasPermission)
        {
            context.Response.StatusCode = 403;
            await context.Response.WriteAsync($"Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ù…Ù†ÙˆØ¹: Ø´Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ '{requirePermissionAttribute.Permission}' Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.");
            return;
        }
    }

    await _next(context);
}
    }

    // Extension Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Middleware
    public static class TokenValidationMiddlewareExtensions
    {
        public static IApplicationBuilder UseTokenValidation(this IApplicationBuilder builder)
        {
            return builder.UseMiddleware<TokenValidationMiddleware>();
        }
    }
}


===== FILE: API\Properties\launchSettings.json =====
{
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:49673",
      "sslPort": 44398
    }
  },
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "http://localhost:80",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "https": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "https://localhost:80;http://localhost:80",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "launchUrl": "swagger",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
      
    },
    "Production": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": false,
      "applicationUrl": "http://localhost:80",  
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Production"
      }
    }
  }
}


===== FILE: API\Services\PermissionDiscoveryService.cs =====
// API/Services/PermissionDiscoveryService.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using API.Attributes;
using App.Contracts.Object.Base.auth;
using Microsoft.AspNetCore.Mvc;

namespace API.Services
{
    public class PermissionDiscoveryService : IPermissionDiscoveryService
    {
        public IEnumerable<string> GetAllPermissionNames()
        {
            var permissions = new HashSet<string>();
            var assembly = Assembly.GetExecutingAssembly(); // ÙÙ‚Ø· Ø§Ø³Ù…Ø¨Ù„ÛŒ API

            var controllers = assembly.GetTypes()
                .Where(t => typeof(ControllerBase).IsAssignableFrom(t) && !t.IsAbstract);

            foreach (var controller in controllers)
            {
                // Ù¾Ø±Ù…ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ø±ÙˆÛŒ Ú©Ù„Ø§Ø³
                var classAttrs = controller.GetCustomAttributes<RequirePermissionAttribute>(true);
                foreach (var attr in classAttrs)
                    permissions.Add(attr.Permission);

                // Ù¾Ø±Ù…ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ø±ÙˆÛŒ Ù…ØªØ¯Ù‡Ø§
                var methods = controller.GetMethods(BindingFlags.Public | BindingFlags.Instance);
                foreach (var method in methods)
                {
                    var methodAttrs = method.GetCustomAttributes<RequirePermissionAttribute>(true);
                    foreach (var attr in methodAttrs)
                        permissions.Add(attr.Permission);
                }
            }

            return permissions;
        }
    }
}

===== FILE: API\utility\FileService.cs =====
using App.utility;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using SixLabors.ImageSharp;
using SixLabors.ImageSharp.Processing;
using System;
using System.IO;
using System.Threading.Tasks;

namespace API.utility
{
    public class FileService : IFileService
    {
        private readonly IWebHostEnvironment _env;
        private const int MaxFileSize = 2 * 1024 * 1024; // 2MB
        private const int ImageSize = 200;

        public FileService(IWebHostEnvironment env)
        {
            _env = env;
        }

        public async Task<string?> UploadProfilePictureAsync(IFormFile? file, string? oldPath = null)
        {
            if (file == null || file.Length == 0) return null;

            if (file.Length > MaxFileSize)
                throw new InvalidOperationException("Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ø¨ÛŒØ´ Ø§Ø² 2 Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø§Ø³Øª.");

            if (!file.ContentType.StartsWith("image/"))
                throw new InvalidOperationException("ÙÙ‚Ø· ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØµÙˆÛŒØ±ÛŒ Ù…Ø¬Ø§Ø² Ù‡Ø³ØªÙ†Ø¯.");

            var uploadsFolder = Path.Combine(_env.WebRootPath, "uploads");
            Directory.CreateDirectory(uploadsFolder);

            var fileName = $"{Guid.NewGuid()}{Path.GetExtension(file.FileName)}";
            var filePath = Path.Combine(uploadsFolder, fileName);

            using var image = await Image.LoadAsync(file.OpenReadStream());
            image.Mutate(x => x.Resize(ImageSize, ImageSize));
            await image.SaveAsync(filePath);

            if (!string.IsNullOrEmpty(oldPath))
            {
                var oldFilePath = Path.Combine(_env.WebRootPath, oldPath.TrimStart('/'));
                if (File.Exists(oldFilePath))
                    File.Delete(oldFilePath);
            }

            return $"/uploads/{fileName}";
        }
    }
}

===== FILE: API\appsettings.Development.json =====
{
  
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}


===== FILE: API\appsettings.json =====
{
    "Kestrel": {
    "Endpoints": {
      "Http": {
        "Url": "http://0.0.0.0:90"
      }
    }
  },
  
  "ConnectionStrings": {
    "DefaultConnection": "Server=.; Database=crm; User Id=sa; Password=Nm123456; Encrypt=True; TrustServerCertificate=True; MultipleActiveResultSets=True;"
  },

  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}


===== FILE: API\Program.cs =====
using API.Middleware;
using API.Services;
using App.Contracts.Object.Base.auth;
using App.Object.Base.Users;
using App.utility;
using ConfApp;
using Infrastructure;
using Infrastructure.data.seed;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.EntityFrameworkCore;
using Microsoft.IdentityModel.Tokens;
using System.Text;

var builder = WebApplication.CreateBuilder(args);

// === Add services to DI ===

builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// === CORS: Allow all origins (dev only) ===
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll", policy =>
    {
        policy.AllowAnyOrigin()
              .AllowAnyMethod()
              .AllowAnyHeader();
    });
});

// === JWT Authentication ===
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = "yourapp",
            ValidAudience = "yourapp",
            IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes("your_secret_key_at_least_16_chars"))
        };
    });

// === Register CRM Services (DbContext, Repos, Apps, etc.) ===
var connectionString = builder.Configuration.GetConnectionString("DefaultConnection")
                       ?? "Data Source=dev.db";

CRMBootstraper.AddCRMManagement(
    builder.Services,
    connectionString,
    connectionString.Contains("Data Source=dev.db") ? DbProvider.Sqlite : DbProvider.SqlServer
);

// === Custom Services ===
builder.Services.AddScoped<IFileService, API.utility.FileService>();
builder.Services.AddScoped<IPermissionDiscoveryService, PermissionDiscoveryService>();
builder.Services.AddScoped<PermissionSeeder>(); // Register seeder

var app = builder.Build();

// === Development-only middleware ===
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();

    // Seed permissions from controllers (only in dev)
    using var scope = app.Services.CreateScope();
    var permissionSeeder = scope.ServiceProvider.GetRequiredService<PermissionSeeder>();
    await permissionSeeder.SeedAsync();
}

// === Global Middleware Pipeline ===
app.UseRouting();

// Log incoming requests
app.Use(async (context, next) =>
{
    var logger = context.RequestServices.GetRequiredService<ILogger<Program>>();
    logger.LogInformation("Request: {Method} {Path}", context.Request.Method, context.Request.Path);
    await next();
    logger.LogInformation("Response: {StatusCode}", context.Response.StatusCode);
});

// Handle preflight (OPTIONS) requests
app.Use(async (context, next) =>
{
    if (context.Request.Method == "OPTIONS")
    {
        context.Response.StatusCode = 200;
        await context.Response.CompleteAsync();
        return;
    }
    await next();
});

app.UseCors("AllowAll");
app.UseAuthentication();
app.UseTokenValidation(); // Custom middleware
app.UseAuthorization();

// === Ensure uploads folder exists ===
var uploadsPath = Path.Combine(app.Environment.WebRootPath, "uploads");
Directory.CreateDirectory(uploadsPath);

// === Background timer: Check inactive users every minute ===
var timer = new Timer(_ =>
{
    using var scope = app.Services.CreateScope();
    var statusService = scope.ServiceProvider.GetRequiredService<UserStatusService>();
    statusService.CheckInactive();
}, null, TimeSpan.Zero, TimeSpan.FromMinutes(1));

// === Map controllers ===
app.MapControllers();

// === Seed initial data (Users, Roles, etc.) ===
using (var scope = app.Services.CreateScope())
{
    var context = scope.ServiceProvider.GetRequiredService<MyContext>();
    var seeder = new DatabaseSeeder(context);
    seeder.SeedAll();
}

app.Run();

===== FILE: API\test.js =====


===== FILE: App\Object\Base\auth\UserContext\UserContext.cs =====

using System.Security.Claims;
using Microsoft.AspNetCore.Http;
using App.Contracts.Object.Base.auth.UserContext;

namespace App.Object.Base.auth.UserContext
{
    public class UserContext : IUserContext
    {
        private readonly IHttpContextAccessor _httpContextAccessor;

        public UserContext(IHttpContextAccessor httpContextAccessor)
        {
            _httpContextAccessor = httpContextAccessor;
        }

        public int? GetUserId()
        {
            if (_httpContextAccessor.HttpContext?.Items.TryGetValue("UserId", out var userIdObj) == true && userIdObj is int userId)
            {
                return userId;
 
            }
            return null;
        }

        public bool IsAuthenticated()
        {
            return _httpContextAccessor.HttpContext?.User.Identity?.IsAuthenticated ?? false;
        }
    }
}

===== FILE: App\Object\Base\auth\AuthApp.cs =====
using App.Contracts.Object.Base.auth;
using Domain.Objects.Base;
using MyFrameWork.AppTool;

namespace App.Object.Base.Auth
{

    public class AuthApp : IAuthApp
    {
        private readonly IUserRepository _userRepository;
        private readonly ITokenApp _tokenService;

        public AuthApp(IUserRepository userRepository, ITokenApp tokenService)
        {
            _userRepository = userRepository;
            _tokenService = tokenService;
        }

      public async Task<OPTResult<AuthResponseDto>> LoginAsync(LoginRequestDto request)
{
    var user = await _userRepository.GetByEmailAsync(request.Email);
    if (user == null)
        return OPTResult<AuthResponseDto>.Failed("Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯.");

    var isPasswordCorrect = BCrypt.Net.BCrypt.Verify(request.Password, user.PasswordHash);
    if (!isPasswordCorrect)
        return OPTResult<AuthResponseDto>.Failed("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.");

    var token = _tokenService.GenerateToken(user);

    return OPTResult<AuthResponseDto>.Success(new AuthResponseDto
    {   UserId = user.Id,
        Email = user.Email,
        FullName = user.FullName,
        Token = token
    });
}

      public async Task<OPTResult<AuthResponseDto>> RegisterAsync(RegisterRequestDto request)
{
    if (await _userRepository.ExistsByEmailAsync(request.Email))
        return OPTResult<AuthResponseDto>.Failed("Ø§ÛŒÙ…ÛŒÙ„ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª.");

    var user = new User
    {
        FullName = request.FullName,
        Email = request.Email,
        PasswordHash = BCrypt.Net.BCrypt.HashPassword(request.Password)
    };

    await _userRepository.AddAsync(user);
    var token = _tokenService.GenerateToken(user);

    return OPTResult<AuthResponseDto>.Success(new AuthResponseDto
    {
        Email = user.Email,
        FullName = user.FullName,
        Token = token
    });
}
    }
    public interface IUserRepository 
    {
        Task<User?> GetByEmailAsync(string email);
        Task AddAsync(User user);
        Task<bool> ExistsByEmailAsync(string email);
    }

}

===== FILE: App\Object\Base\auth\IPermissionRep.cs =====
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace App.Object.Base.auth
{
    public interface IPermissionRep 
    {
        Task<bool> HasPermissionAsync(int userId, string permission);
    }
}

===== FILE: App\Object\Base\auth\PermissionService.cs =====
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using App.Contracts.Object.Base.auth;

namespace App.Object.Base.auth
{
    public class PermissionService :IPermissionService
    {
       private readonly IPermissionRep _permissionRep;

        public PermissionService (IPermissionRep permissionRep)
        {
            _permissionRep = permissionRep;
        }

        public async Task<bool> HasPermissionAsync(int userId, string permission)
        {
            return await _permissionRep.HasPermissionAsync(userId, permission);
        }
    }
}

===== FILE: App\Object\Base\auth\TokenApp.cs =====

using App.Contracts.Object.Base.auth;
using Domain.Objects.Base;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

namespace App.Object.Base.auth
{
    public class TokenApp : ITokenApp
    {




        public string GenerateToken(User user)
        {
            var claims = new[]
            {
        new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),
        new Claim(ClaimTypes.Email, user.Email),
        new Claim(ClaimTypes.Name, user.FullName)
    };

            // ðŸ”’ Ù‡Ø§Ø±Ø¯Ú©Ø¯ Ù…ÙˆÙ‚ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø¶Ø§
            var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes("your_secret_key_at_least_16_chars")); // Ø§ÛŒÙ†Ùˆ Ø¨Ø¹Ø¯Ø§Ù‹ Ù…ÛŒâ€ŒØ¨Ø±ÛŒ ØªÙˆÛŒ appsettings
            var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

            var token = new JwtSecurityToken(
                issuer: "yourapp",
                audience: "yourapp",
                claims: claims,
                expires: DateTime.Now.AddHours(1),
                signingCredentials: creds
            );

            return new JwtSecurityTokenHandler().WriteToken(token);
        }
    }
}

===== FILE: App\Object\Base\Users\Roles\IRoleRep.cs =====
using App;
using Domain.Objects.Base;

public interface IRoleRep :  IBaseRep<Role, int> {


}

===== FILE: App\Object\Base\Users\UsersApp.cs =====
// App/Object/Base/Users/UsersApp.cs
using App.Contracts.Object.Base.Users;
using App.Object.Base;
using App.utility;
using AutoMapper;
using Domain.Objects.Base;
using MyFrameWork.AppTool;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace App.Object.Base.Users
{
    public class UsersApp : CrudService<User, UsersView, UsersCreat, UsersUpdate, int>,
                            IUsersApp
    {
        private readonly IMyUserRepository _userRepository;
        private readonly IFileService _fileService;
        private readonly UserStatusService _statusService;
        private readonly IRoleRep _roleRep;

        public UsersApp(
            IMyUserRepository userRepository,
            IMapper mapper,
            IFileService fileService,
            UserStatusService statusService,
            IRoleRep roleRep)
            : base(userRepository, mapper)
        {
            _userRepository = userRepository;
            _fileService = fileService;
            _statusService = statusService;
            _roleRep = roleRep;
        }

        /*=== Ø§ÛŒÙ†ØªØ±ÙÛŒØ³ IUsersApp ===*/
        public Task<ApiResult<List<UsersView>>> GetAll(Pagination pagination) => base.GetAllAsync(pagination);
        public Task<ApiResult<UsersUpdate>> GetById(int id)                 => base.GetByIdAsync(id);
        public Task<ApiResult> Create(UsersCreat dto)                       => base.CreateAsync(dto);
        public Task<ApiResult> Update(UsersUpdate dto)                      => base.UpdateAsync(dto);
        public Task<ApiResult> DeleteBy(List<int> ids)                      => base.DeleteAsync(ids);

        /*=== Ù…ØªØ¯Ù‡Ø§ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ ===*/
        public async Task<ApiResult<UserCreateFormData>> CreateForm()
        {
            var roles = await _roleRep.GetAsync();
            return ApiResult<UserCreateFormData>.Success(
                new UserCreateFormData
                {
                    Roles = roles.Select(r => new RoleView { Id = r.Id, Name = r.Name }).ToList()
                });
        }

        public async Task<ApiResult> KeepAlive(int userId)
        {
            _statusService.UpdateStatus(userId, UserStatus.Online, DateTime.Now);
            return ApiResult.Success("ÙˆØ¶Ø¹ÛŒØª Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´Ø¯.");
        }

        /*=== Ø§ÙˆØ±Ø±Ø§ÛŒØ¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ (Business + ÙØ§ÛŒÙ„ + ÙˆØ¶Ø¹ÛŒØª) ===*/
        public override async Task<ApiResult> CreateAsync(UsersCreat dto)
        {
            if (await _userRepository.ExistAsync(u => u.Email == dto.Email))
                return ApiResult.Failed("Ø§ÛŒÙ…ÛŒÙ„ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.", 400);
            if (await _userRepository.ExistAsync(u => u.Username == dto.Username))
                return ApiResult.Failed("Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.", 400);

            var user = _mapper.Map<User>(dto);
            user.PasswordHash = BCrypt.Net.BCrypt.HashPassword(dto.Password);
            user.UserRoles = dto.RoleIds.Select(rid => new UserRole { RoleId = rid }).ToList();

            if (dto.ProfilePicture != null)
            {
                try { user.ProfilePictureUrl = await _fileService.UploadProfilePictureAsync(dto.ProfilePicture); }
                catch (Exception ex) { return ApiResult.Failed($"Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±: {ex.Message}", 400); }
            }

            await _userRepository.CreateAsync(user);
            await _userRepository.SaveChangesAsync();
            _statusService.UpdateStatus(user.Id, UserStatus.Offline);
            return ApiResult.Success(message: $"Ú©Ø§Ø±Ø¨Ø± {dto.FullName} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯.");
        }

        public override async Task<ApiResult> UpdateAsync(UsersUpdate dto)
        {
            if (await _userRepository.ExistAsync(u => u.Email == dto.Email && u.Id != dto.Id))
                return ApiResult.Failed("Ø§ÛŒÙ…ÛŒÙ„ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.", 400);
            if (await _userRepository.ExistAsync(u => u.Username == dto.Username && u.Id != dto.Id))
                return ApiResult.Failed("Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.", 400);

            var user = await _userRepository.GetAsync(dto.Id);
            if (user == null) return ApiResult.Failed(MessageApp.NotFound, 404);

            _mapper.Map(dto, user);
            if (!string.IsNullOrEmpty(dto.Password))
                user.PasswordHash = BCrypt.Net.BCrypt.HashPassword(dto.Password);

            user.UserRoles = dto.RoleIds.Select(rid => new UserRole { RoleId = rid, UserId = dto.Id }).ToList();

            if (dto.ProfilePicture != null)
            {
                try { user.ProfilePictureUrl = await _fileService.UploadProfilePictureAsync(dto.ProfilePicture, user.ProfilePictureUrl); }
                catch (Exception ex) { return ApiResult.Failed($"Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±: {ex.Message}", 400); }
            }

            await _userRepository.UpdateAsync(user);
            await _userRepository.SaveChangesAsync();
            return ApiResult.Success(message: "Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.");
        }

        public override async Task<ApiResult<List<UsersView>>> GetAllAsync(Pagination pagination)
        {
            var users = await _userRepository.GetAsync(pagination);
            var vms = _mapper.Map<List<UsersView>>(users);

            foreach (var vm in vms)
            {
                var (status, lastSeen) = _statusService.GetStatus(vm.Id);
                vm.Status   = status;
                vm.LastSeen = lastSeen;
            }

            var total = await _userRepository.CountAsync();
            return ApiResult<List<UsersView>>.PagedSuccess(vms, total,
                                                           pagination.PageNumber,
                                                           pagination.PageSize);
        }

        public override async Task<ApiResult> DeleteAsync(List<int> ids)
        {
            var res = await base.DeleteAsync(ids);
            if (res.IsSucceeded) ids.ForEach(id => _statusService.UpdateStatus(id, UserStatus.Offline));
            return res;
        }
    }

    public interface IMyUserRepository : IBaseRep<User, int> { }
}

