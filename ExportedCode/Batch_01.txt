===== FILE: API\Attributes\RequirePermissionAttribute.cs =====
using Microsoft.AspNetCore.Mvc;

namespace API.Attributes
{
    [AttributeUsage(AttributeTargets.Class | AttributeTargets.Method)]
    public class RequirePermissionAttribute : Attribute
    {
        public string Permission { get; }
        public RequirePermissionAttribute(string permission)
        {
            Permission = permission;
        }
    }
}

===== FILE: API\Controllers\bases\AuthController.cs =====
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Threading.Tasks;
using App.Contracts.Object.Base.auth;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using MyFrameWork.AppTool;

namespace API.Controllers.bases
{

    [ApiController]
    [Route("api/[controller]")]
    public class AuthController : ControllerBase
    {
        private readonly IAuthApp _authApp;

        public AuthController(IAuthApp authApp)
        {
            _authApp = authApp;
        }

        [HttpPost("login")]
        public async Task<ActionResult<OPTResult<AuthResponseDto>>> Login([FromBody] LoginRequestDto request)
        {
            var result = await _authApp.LoginAsync(request);
            if (result.IsSucceeded == false)
                return BadRequest(result);

            return Ok(result);
        }

        [HttpPost("register")]
        public async Task<IActionResult> Register(RegisterRequestDto dto)
        {
            var result = await _authApp.RegisterAsync(dto);
            if (result.IsSucceeded == false)
                return BadRequest(result.Message);
            return Ok(result.Data);
        }
    }
}

===== FILE: API\Controllers\bases\UserController.cs =====
// API\Controllers\bases\UserController.cs
using API.Attributes;
using App.Contracts.Object.Base.Users;
using Microsoft.AspNetCore.Mvc;
using MyFrameWork.AppTool;

namespace API.Controllers.bases
{
    [ApiController]
    [Route("api/[controller]")]
    public class UserController : BaseController
    {
        private readonly IUsersApp _usersApp;

        public UserController(IUsersApp usersApp)
        {
            _usersApp = usersApp;
        }

        private List<string> GetModelStateErrors()
        {
            return ModelState.Values
                .SelectMany(v => v.Errors)
                .Select(e => e.ErrorMessage)
                .ToList();
        }

        [RequirePermission("User.View")]
        [HttpPost("/api/User/GetAll")]
        public async Task<ActionResult<ApiResult>> GetAll([FromBody] Pagination pagination)
        {
            var result = await _usersApp.GetAll(pagination);
            return result.IsSucceeded ? Ok(result) : BadRequest(result);
        }

        [RequirePermission("User.View")]
        [HttpGet("/api/User/GetById")]
        public async Task<ActionResult<ApiResult>> GetById([FromQuery] int id)
        {
            var result = await _usersApp.GetById(id);
            return result.IsSucceeded ? Ok(result) : BadRequest(result);
        }

        [RequirePermission("User.Create")]
        [HttpPost("/api/User/create")]
        public async Task<ActionResult<ApiResult>> Create([FromForm] UsersCreat userCreate)
        {
            if (!ModelState.IsValid)
                return BadRequest(ApiResult.Failed(GetModelStateErrors(), 400));

            var result = await _usersApp.Create(userCreate);
            return result.IsSucceeded ? Ok(result) : BadRequest(result);
        }

        [RequirePermission("User.Edit")]
        [HttpPost("/api/User/update")]
        public async Task<ActionResult<ApiResult>> Update([FromForm] UsersUpdate userUpdate)
        {
            if (!ModelState.IsValid)
                return BadRequest(ApiResult.Failed(GetModelStateErrors(), 400));

            var result = await _usersApp.Update(userUpdate);
            return result.IsSucceeded ? Ok(result) : BadRequest(result);
        }

        [RequirePermission("User.Delete")]
        [HttpPost("/api/User/delete")]
        public async Task<ActionResult<ApiResult>> Delete([FromBody] List<int> ids)
        {
            if (!ModelState.IsValid)
                return BadRequest(ApiResult.Failed(GetModelStateErrors(), 400));

            var result = await _usersApp.DeleteBy(ids);
            return result.IsSucceeded ? Ok(result) : BadRequest(result);
        }

        // KeepAlive: Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ permission Ù†ÛŒØ³Øª (Ú©Ø§Ø±Ø¨Ø± Ø®ÙˆØ¯Ø´ Ø±Ùˆ Ø¢Ù†Ù„Ø§ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ù‡)
        [HttpPost("/api/User/keepalive")]
        public async Task<ActionResult<ApiResult>> KeepAlive()
        {
            var userId = GetCurrentUserId();
            if (userId <= 0)
                return Unauthorized(ApiResult.Failed("Ú©Ø§Ø±Ø¨Ø± Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.", 401));

            var result = await _usersApp.KeepAlive(userId);
            return result.IsSucceeded ? Ok(result) : BadRequest(result);
        }

        [RequirePermission("User.Create")]
        [HttpGet("/api/user/getcreateform")]
        public async Task<ActionResult<ApiResult>> GetCreateForm()
        {
            var result = await _usersApp.CreateForm();
            return result.IsSucceeded ? Ok(result) : BadRequest(result);
        }
    }
}

===== FILE: API\Controllers\Shop\CountTypeController.cs =====
using App.Contracts.Object.Shop.CountTypeCon;
using App.Contracts.Object.Shop.ProductCon;
using Microsoft.AspNetCore.Mvc;
using MyFrameWork.AppTool;

namespace API.Controllers.Shop
{

    public class CountTypeController : BaseController
    {
            private readonly ICountTypeApp countTypeApp;

           public CountTypeController(ICountTypeApp countTypeApp)
        {
            this.countTypeApp = countTypeApp;
        }
       

        [HttpPost]
        [Route("/api/CountType/GetAll")]
        public async Task<ActionResult<OPTResult<CountTypeView>>> Index([FromBody] Pagination pagination)
        {
             return await countTypeApp.GetAll(pagination);

             

            
        }
        [HttpGet]
        [Route("/api/CountType/GetById")]
        public async Task<ActionResult<OPTResult<CountTypeView>>> GetById([FromQuery] int id)
        {
            var result = await countTypeApp.GetById(id);
            if (result.IsSucceeded == true) { return Ok(result); }
            else { return Ok(result); }
        }
        


      


        [HttpPost]
        [Route("/api/CountType/create")]
        public async Task<ActionResult> create([FromBody] CountTypeCreate countTypeCreate)
        {

            var opt = await countTypeApp.Create(countTypeCreate);
            if (opt.IsSucceeded==true) { return Ok(opt); }
            else { return Ok ( opt); }
            

        }
       

        [HttpPost]
        [Route("/api/CountType/delete")]
        public async Task<ActionResult> delete([FromBody] List<int> ids)
        {
            var result = await countTypeApp.DeleteBy(ids); 
            return Ok(result);
        }

        [HttpDelete]
        [Route("/api/CountType/deletebyid")]
        public OkResult deletebyid([FromQuery] int id)
        {
            var ids = new List<int> { id };
            countTypeApp.DeleteBy(ids); // ØªØºÛŒÛŒØ± Ù…ØªØ¯ DeleteBy Ø¨Ø±Ø§ÛŒ Ù¾Ø°ÛŒØ±Ø´ Ù„ÛŒØ³Øª Ø¢ÛŒâ€ŒØ¯ÛŒâ€ŒÙ‡Ø§
            return Ok();
        }


        [HttpPost]
        [Route("/api/CountType/update")]
        public async Task<ActionResult> update([FromBody] CountTypeView countTypeView)
        {
            var opt = await countTypeApp.Update(countTypeView);
            if (opt.IsSucceeded == true) { return Ok(opt); }
            else { return Ok(opt); }  
        }        
        [HttpGet("/api/counttype/CountTypelist")]
        public IActionResult CountTypeList()
        {
            var pagination = new Pagination
            {
                PageNumber = 1,
                PageSize = 1000
            };
            var list = countTypeApp.GetAll(pagination);
            return Ok(list);
        }
       
    }
}


===== FILE: API\Controllers\Shop\InvController.cs =====
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Threading.Tasks;
using API.Attributes;
using App.Contracts.Object.Shop.InvCon;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using MyFrameWork.AppTool;

namespace API.Controllers.Shop
{
    [Route("[controller]")]
    [Authorize]
    public class InvController : BaseController
    {


        private readonly IInvApp invApp;
        private readonly ILogger<InvController> _logger;
        public InvController(IInvApp invApp, ILogger<InvController> logger)
        {
            this.invApp = invApp;
            _logger = logger;

        }



        [HttpPost]
        [Route("/api/inv/GetAll")]
        [RequirePermission("ViewProducs")]
        public async Task<ActionResult<ApiResult>> Index([FromBody] Pagination pagination)
        {
            return await invApp.GetAll(pagination);
        }

        [HttpGet]
        [Route("/api/inv/GetById")]
        public async Task<ActionResult<OPTResult<InvUpdate>>> GetById([FromQuery] int id)
        {
            var result = await invApp.GetById(id);
            if (result.IsSucceeded == true) { return Ok(result); }
            else { return Ok(result); }
        }

        [HttpPost]
        [Route("/api/inv/create")]
        public async Task<ActionResult> create([FromBody] InvCreate invCreate)
        {

            var opt = await invApp.Create(invCreate);
            if (opt.IsSucceeded == true) { return Ok(opt); }
            else { return Ok(opt); }


        }

        [HttpPost]
        [Route("/api/inv/delete")]
        public async Task<ActionResult> delete([FromBody] List<int> ids)
        {
            var result = await invApp.DeleteBy(ids);
            return Ok(result);
        }

        [HttpDelete]
        [Route("/api/inv/deletebyid")]
        public OkResult deletebyid([FromQuery] int id)
        {
            var ids = new List<int> { id };
            invApp.DeleteBy(ids); // ØªØºÛŒÛŒØ± Ù…ØªØ¯ DeleteBy Ø¨Ø±Ø§ÛŒ Ù¾Ø°ÛŒØ±Ø´ Ù„ÛŒØ³Øª Ø¢ÛŒâ€ŒØ¯ÛŒâ€ŒÙ‡Ø§
            return Ok();
        }


        [HttpPost]
        [Route("/api/inv/update")]
        public async Task<ActionResult> update([FromBody] InvUpdate invUpdate)
        {
            var opt = await invApp.Update(invUpdate);
            if (opt.IsSucceeded == true) { return Ok(opt); }
            else { return Ok(opt); }  
        }  


    }
}

===== FILE: API\Controllers\Shop\ProductController.cs =====
using API.Attributes;
using App.Contracts.Object.Shop.ProductCon;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using MyFrameWork.AppTool;

namespace API.Controllers.Shop
{
    /// <summary>
    /// کنترلر مربوط به مدیریت محصولات در سیستم
    /// </summary>
    
    [Authorize]
    public class ProductController : BaseController
    {
        private readonly IProductApp _productApp;

        /// <summary>
        /// سازنده کنترلر، تزریق وابستگی IProductApp
        /// </summary>
        /// <param name="productApp">سرویس لایه اپلیکیشن برای مدیریت محصولات</param>
        public ProductController(IProductApp productApp)
        {
            _productApp = productApp;
        }

        /// <summary>
        /// دریافت لیست محصولات با صفحه‌بندی
        /// </summary>
        /// <param name="pagination">اطلاعات صفحه‌بندی</param>
        /// <returns>لیست محصولات یا خطای عدم دسترسی</returns>
        
        [RequirePermission("ViewProduct")]
        [HttpPost]
        [Route("/api/product/GetAll")]
        
        public async Task<ActionResult<OPTResult<ProductView>>> Index([FromBody] Pagination pagination)
        {
           
            // فراخوانی متد GetAll از لایه اپلیکیشن با userId
            return await _productApp.GetAll(pagination);
        }

        /// <summary>
        /// جستجوی محصولات بر اساس معیارهای مشخص
        /// </summary>
        /// <param name="productSearch">معیارهای جستجو</param>
        /// <returns>لیست محصولات فیلترشده</returns>
        [HttpPost]
        [Route("/api/product/search")]
        public async Task<ActionResult<OPTResult<ProductView>>> Search([FromBody] ProductSearchCriteria productSearch)
        {
            return await _productApp.SearchProducts(productSearch);
        }

        /// <summary>
        /// ایجاد محصول جدید
        /// </summary>
        /// <param name="product">اطلاعات محصول جدید</param>
        /// <returns>نتیجه عملیات ایجاد</returns>
        [HttpPost]
        [Route("/api/product/create")]
        public async Task<ActionResult> Create([FromBody] ProductCreate product)
        {
            var opt = await _productApp.Create(product);
            return Ok(opt);
        }

        /// <summary>
        /// حذف محصولات بر اساس لیست آیدی‌ها
        /// </summary>
        /// <param name="ids">لیست آیدی‌های محصولات</param>
        /// <returns>نتیجه عملیات حذف</returns>
        [HttpPost]
        [Route("/api/product/delete")]
        public async Task<OkObjectResult> Delete([FromBody] List<int> ids)
        {
            var opt = await _productApp.DeleteBy(ids);
            return Ok(opt);
        }

        /// <summary>
        /// دریافت اطلاعات یک محصول بر اساس آیدی
        /// </summary>
        /// <param name="id">آیدی محصول</param>
        /// <returns>اطلاعات محصول یا پیام خطا</returns>
        [HttpGet]
        [Route("/api/product/GetById")]
        public async Task<ActionResult<OPTResult<ProductUpdate>>> GetById([FromQuery] int id)
        {
            var result = await _productApp.GetById(id);
            if (result.IsSucceeded)
            {
                return Ok(result);
            }
            return Ok(new { warning = result.Message });
        }

        /// <summary>
        /// به‌روزرسانی اطلاعات محصول
        /// </summary>
        /// <param name="product">اطلاعات به‌روزرسانی‌شده محصول</param>
        /// <returns>نتیجه عملیات به‌روزرسانی</returns>
        [HttpPost]
        [Route("/api/product/update")]
        public async Task<ActionResult> Update([FromBody] ProductView product)
        {
            var opt = await _productApp.Update(product);
            if (opt.IsSucceeded)
            {
                return Ok(opt);
            }
            return Ok(new { warning = opt.Message });
        }
    }
}

===== FILE: API\Controllers\BaseController.cs =====
using System.Security.Claims;
using Microsoft.AspNetCore.Mvc;

namespace API.Controllers
{

    [ApiController]
    public class BaseController : ControllerBase
    {
        protected int GetCurrentUserId()
        {
            var userIdClaim = User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier);
            if (userIdClaim == null || !int.TryParse(userIdClaim.Value, out int userId))
            {
                throw new UnauthorizedAccessException("User ID not found in token.");
            }
            return userId;
        }
    }
}


===== FILE: API\Controllers\MetadataController.cs =====
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Reflection;
using Microsoft.AspNetCore.Mvc;
using MyFrameWork.AppTool;

namespace API.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class MetadataController : ControllerBase
    {
        [HttpGet("GetModelMetadata/{modelName}")]
        public IActionResult GetModelMetadata(string modelName)
        {
            var assembly = Assembly.Load("App.Contracts");

            var type = assembly.GetTypes()
                .FirstOrDefault(t =>
                    t.IsClass &&
                    t.Namespace != null &&
                    t.Namespace.StartsWith("App.Contracts") &&
                    t.Name.Equals(modelName, StringComparison.OrdinalIgnoreCase));

            if (type == null)
                return NotFound($"Model '{modelName}' not found.");

            var propertyMetadata = new List<object>();

            foreach (var prop in type.GetProperties())
            {
                var displayAttr = prop.GetCustomAttribute<DisplayAttribute>();
                var requiredAttr = prop.GetCustomAttribute<RequiredAttribute>();
                var stringLengthAttr = prop.GetCustomAttribute<StringLengthAttribute>();
                var minLengthAttr = prop.GetCustomAttribute<MinLengthAttribute>();
                var maxLengthAttr = prop.GetCustomAttribute<MaxLengthAttribute>();
                var selectSourceAttr = prop.GetCustomAttribute<SelectSourceAttribute>();

                var inputType = prop.PropertyType == typeof(bool) ? "boolean" :
                                prop.PropertyType == typeof(int) || prop.PropertyType == typeof(long) ? "number" :
                                "text";

                var metadata = new
                {
                    name = ToCamelCase(prop.Name),
                    displayName = displayAttr?.Name ?? prop.Name,
                    inputType,
                    controlType = selectSourceAttr != null ? "select" : null,
                    selectSource = selectSourceAttr?.SourceName,
                    required = requiredAttr != null,
                    maxLength = maxLengthAttr?.Length ?? stringLengthAttr?.MaximumLength,
                    minLength = minLengthAttr?.Length ?? stringLengthAttr?.MinimumLength
                };

                propertyMetadata.Add(metadata);
            }

            return Ok(new Dictionary<string, List<object>> { { type.Name, propertyMetadata } });
        }

        private static string ToCamelCase(string input)
        {
            if (string.IsNullOrEmpty(input) || char.IsLower(input[0]))
                return input;

            return char.ToLower(input[0]) + input.Substring(1);
        }
    }
}


===== FILE: API\Middleware\TokenValidationMiddleware.cs =====
using API.Attributes;
using App.Contracts.Object.Base.auth;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging;
using System.Security.Claims;
using System.Threading.Tasks;

namespace API.Middleware
{
    public class TokenValidationMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<TokenValidationMiddleware> _logger;

        public TokenValidationMiddleware(RequestDelegate next, ILogger<TokenValidationMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

  public async Task InvokeAsync(HttpContext context, IPermissionService permissionService)
{
    var endpoint = context.GetEndpoint();
    var authorizeAttribute = endpoint?.Metadata.GetMetadata<Microsoft.AspNetCore.Authorization.AuthorizeAttribute>();

    // Ø§Ú¯Ø± Ø§Ú©Ø´Ù† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù„Ø§Ú¯ÛŒÙ† Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù‡
    if (authorizeAttribute == null)
    {
        await _next(context);
        return;
    }

    // 1. Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
    if (!context.User.Identity?.IsAuthenticated ?? true)
    {
        context.Response.StatusCode = 401;
        await context.Response.WriteAsync("Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²: ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±.");
        return;
    }

    // 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ userId
    var userIdClaim = context.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    if (!int.TryParse(userIdClaim, out int userId))
    {
        context.Response.StatusCode = 401;
        await context.Response.WriteAsync("ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±: Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.");
        return;
    }

    context.Items["UserId"] = userId;

    // 3. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾Ø±Ù…ÛŒØ´Ù† Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø§Ø² Attribute Ø³ÙØ§Ø±Ø´ÛŒ
    var requirePermissionAttribute = endpoint?.Metadata.GetMetadata<RequirePermissionAttribute>();
    if (requirePermissionAttribute != null)
    {
        bool hasPermission = await permissionService.HasPermissionAsync(userId, requirePermissionAttribute.Permission);
        if (!hasPermission)
        {
            context.Response.StatusCode = 403;
            await context.Response.WriteAsync($"Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ù…Ù†ÙˆØ¹: Ø´Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ '{requirePermissionAttribute.Permission}' Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.");
            return;
        }
    }

    await _next(context);
}
    }

    // Extension Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Middleware
    public static class TokenValidationMiddlewareExtensions
    {
        public static IApplicationBuilder UseTokenValidation(this IApplicationBuilder builder)
        {
            return builder.UseMiddleware<TokenValidationMiddleware>();
        }
    }
}


===== FILE: API\Properties\launchSettings.json =====
{
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:49673",
      "sslPort": 44398
    }
  },
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "http://localhost:80",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "https": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "https://localhost:80;http://localhost:80",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "launchUrl": "swagger",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
      
    },
    "Production": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": false,
      "applicationUrl": "http://localhost:80",  
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Production"
      }
    }
  }
}


===== FILE: API\utility\FileService.cs =====
using App.utility;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using SixLabors.ImageSharp;
using SixLabors.ImageSharp.Processing;
using System;
using System.IO;
using System.Threading.Tasks;

namespace API.utility
{
    public class FileService : IFileService
    {
        private readonly IWebHostEnvironment _env;
        private const int MaxFileSize = 2 * 1024 * 1024; // 2MB
        private const int ImageSize = 200;

        public FileService(IWebHostEnvironment env)
        {
            _env = env;
        }

        public async Task<string?> UploadProfilePictureAsync(IFormFile? file, string? oldPath = null)
        {
            if (file == null || file.Length == 0) return null;

            if (file.Length > MaxFileSize)
                throw new InvalidOperationException("Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ø¨ÛŒØ´ Ø§Ø² 2 Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø§Ø³Øª.");

            if (!file.ContentType.StartsWith("image/"))
                throw new InvalidOperationException("ÙÙ‚Ø· ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØµÙˆÛŒØ±ÛŒ Ù…Ø¬Ø§Ø² Ù‡Ø³ØªÙ†Ø¯.");

            var uploadsFolder = Path.Combine(_env.WebRootPath, "uploads");
            Directory.CreateDirectory(uploadsFolder);

            var fileName = $"{Guid.NewGuid()}{Path.GetExtension(file.FileName)}";
            var filePath = Path.Combine(uploadsFolder, fileName);

            using var image = await Image.LoadAsync(file.OpenReadStream());
            image.Mutate(x => x.Resize(ImageSize, ImageSize));
            await image.SaveAsync(filePath);

            if (!string.IsNullOrEmpty(oldPath))
            {
                var oldFilePath = Path.Combine(_env.WebRootPath, oldPath.TrimStart('/'));
                if (File.Exists(oldFilePath))
                    File.Delete(oldFilePath);
            }

            return $"/uploads/{fileName}";
        }
    }
}

===== FILE: API\appsettings.Development.json =====
{
  
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}


===== FILE: API\appsettings.json =====
{
    "Kestrel": {
    "Endpoints": {
      "Http": {
        "Url": "http://0.0.0.0:90"
      }
    }
  },
  
  "ConnectionStrings": {
    "DefaultConnection": "Server=.; Database=crm; User Id=sa; Password=Nm123456; Encrypt=True; TrustServerCertificate=True; MultipleActiveResultSets=True;"
  },

  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}


===== FILE: API\Program.cs =====
using Infrastructure;
using Infrastructure.data.seed;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.IdentityModel.Tokens;
using System.Text;
using API.Middleware;
using App.Object.Base.Users;
using ConfApp;

var builder = WebApplication.CreateBuilder(args);

// === CORS ===
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll", policy =>
    {
        policy.AllowAnyOrigin()
              .AllowAnyMethod()
              .AllowAnyHeader();
    });
});

// === Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ===
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// === Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª JWT ===
builder.Services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = true,
        ValidateAudience = true,
        ValidateLifetime = true,
        ValidateIssuerSigningKey = true,
        ValidIssuer = "yourapp",
        ValidAudience = "yourapp",
        IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes("your_secret_key_at_least_16_chars"))
    };
});

// === Ø«Ø¨Øª ØªÙ…Ø§Ù… Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ CRM (Ø´Ø§Ù…Ù„ FileService, UserStatusService, DbContext Ùˆ ...) ===
var connectionString = builder.Configuration.GetConnectionString("DefaultConnection") 
                       ?? "Data Source=dev.db";

CRMBootstraper.AddCRMManagement(
    builder.Services,
    connectionString,
    connectionString.Contains("Data Source=dev.db") ? DbProvider.Sqlite : DbProvider.SqlServer
);
builder.Services.AddScoped<App.utility.IFileService, API.utility.FileService>();
var app = builder.Build();

// === Middleware Pipeline ===
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseRouting();

// Ù„Ø§Ú¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
app.Use(async (context, next) =>
{
    var logger = context.RequestServices.GetRequiredService<ILogger<Program>>();
    logger.LogInformation("Received {Method} {Path}", context.Request.Method, context.Request.Path);
    await next();
    logger.LogInformation("Response: {StatusCode}", context.Response.StatusCode);
});

// Preflight
app.Use(async (context, next) =>
{
    if (context.Request.Method == "OPTIONS")
    {
        context.Response.StatusCode = 200;
        await context.Response.CompleteAsync();
        return;
    }
    await next();
});

app.UseCors("AllowAll");
app.UseAuthentication();
app.UseTokenValidation();
app.UseAuthorization();

// === Ø§ÛŒØ¬Ø§Ø¯ ÙÙˆÙ„Ø¯Ø± uploads ===
var uploadsPath = Path.Combine(app.Environment.WebRootPath, "uploads");
if (!Directory.Exists(uploadsPath))
    Directory.CreateDirectory(uploadsPath);

// === ØªØ§ÛŒÙ…Ø± Ú†Ú© ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (Ù‡Ø± 1 Ø¯Ù‚ÛŒÙ‚Ù‡) ===
var timer = new Timer(_ =>
{
    var statusService = app.Services.GetRequiredService<UserStatusService>();
    statusService.CheckInactive();
}, null, TimeSpan.Zero, TimeSpan.FromMinutes(1));

app.MapControllers();

// === Seed Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ===
using (var scope = app.Services.CreateScope())
{
    var context = scope.ServiceProvider.GetRequiredService<MyContext>();
    var seeder = new DatabaseSeeder(context);
    seeder.SeedAll();
}

app.Run();

===== FILE: API\test.js =====


===== FILE: App\Object\Base\auth\UserContext\UserContext.cs =====

using System.Security.Claims;
using Microsoft.AspNetCore.Http;
using App.Contracts.Object.Base.auth.UserContext;

namespace App.Object.Base.auth.UserContext
{
    public class UserContext : IUserContext
    {
        private readonly IHttpContextAccessor _httpContextAccessor;

        public UserContext(IHttpContextAccessor httpContextAccessor)
        {
            _httpContextAccessor = httpContextAccessor;
        }

        public int? GetUserId()
        {
            if (_httpContextAccessor.HttpContext?.Items.TryGetValue("UserId", out var userIdObj) == true && userIdObj is int userId)
            {
                return userId;
 
            }
            return null;
        }

        public bool IsAuthenticated()
        {
            return _httpContextAccessor.HttpContext?.User.Identity?.IsAuthenticated ?? false;
        }
    }
}

===== FILE: App\Object\Base\auth\AuthApp.cs =====
using App.Contracts.Object.Base.auth;
using Domain.Objects.Base;
using MyFrameWork.AppTool;

namespace App.Object.Base.Auth
{

    public class AuthApp : IAuthApp
    {
        private readonly IUserRepository _userRepository;
        private readonly ITokenApp _tokenService;

        public AuthApp(IUserRepository userRepository, ITokenApp tokenService)
        {
            _userRepository = userRepository;
            _tokenService = tokenService;
        }

      public async Task<OPTResult<AuthResponseDto>> LoginAsync(LoginRequestDto request)
{
    var user = await _userRepository.GetByEmailAsync(request.Email);
    if (user == null)
        return OPTResult<AuthResponseDto>.Failed("Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯.");

    var isPasswordCorrect = BCrypt.Net.BCrypt.Verify(request.Password, user.PasswordHash);
    if (!isPasswordCorrect)
        return OPTResult<AuthResponseDto>.Failed("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.");

    var token = _tokenService.GenerateToken(user);

    return OPTResult<AuthResponseDto>.Success(new AuthResponseDto
    {   UserId = user.Id,
        Email = user.Email,
        FullName = user.FullName,
        Token = token
    });
}

      public async Task<OPTResult<AuthResponseDto>> RegisterAsync(RegisterRequestDto request)
{
    if (await _userRepository.ExistsByEmailAsync(request.Email))
        return OPTResult<AuthResponseDto>.Failed("Ø§ÛŒÙ…ÛŒÙ„ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª.");

    var user = new User
    {
        FullName = request.FullName,
        Email = request.Email,
        PasswordHash = BCrypt.Net.BCrypt.HashPassword(request.Password)
    };

    await _userRepository.AddAsync(user);
    var token = _tokenService.GenerateToken(user);

    return OPTResult<AuthResponseDto>.Success(new AuthResponseDto
    {
        Email = user.Email,
        FullName = user.FullName,
        Token = token
    });
}
    }
    public interface IUserRepository
    {
        Task<User?> GetByEmailAsync(string email);
        Task AddAsync(User user);
        Task<bool> ExistsByEmailAsync(string email);
    }

}

===== FILE: App\Object\Base\auth\IPermissionRep.cs =====
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace App.Object.Base.auth
{
    public interface IPermissionRep 
    {
        Task<bool> HasPermissionAsync(int userId, string permission);
    }
}

===== FILE: App\Object\Base\auth\PermissionService.cs =====
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using App.Contracts.Object.Base.auth;

namespace App.Object.Base.auth
{
    public class PermissionService :IPermissionService
    {
       private readonly IPermissionRep _permissionRep;

        public PermissionService (IPermissionRep permissionRep)
        {
            _permissionRep = permissionRep;
        }

        public async Task<bool> HasPermissionAsync(int userId, string permission)
        {
            return await _permissionRep.HasPermissionAsync(userId, permission);
        }
    }
}

===== FILE: App\Object\Base\auth\TokenApp.cs =====

using App.Contracts.Object.Base.auth;
using Domain.Objects.Base;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

namespace App.Object.Base.auth
{
    public class TokenApp : ITokenApp
    {




        public string GenerateToken(User user)
        {
            var claims = new[]
            {
        new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),
        new Claim(ClaimTypes.Email, user.Email),
        new Claim(ClaimTypes.Name, user.FullName)
    };

            // ðŸ”’ Ù‡Ø§Ø±Ø¯Ú©Ø¯ Ù…ÙˆÙ‚ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø¶Ø§
            var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes("your_secret_key_at_least_16_chars")); // Ø§ÛŒÙ†Ùˆ Ø¨Ø¹Ø¯Ø§Ù‹ Ù…ÛŒâ€ŒØ¨Ø±ÛŒ ØªÙˆÛŒ appsettings
            var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

            var token = new JwtSecurityToken(
                issuer: "yourapp",
                audience: "yourapp",
                claims: claims,
                expires: DateTime.Now.AddHours(1),
                signingCredentials: creds
            );

            return new JwtSecurityTokenHandler().WriteToken(token);
        }
    }
}

===== FILE: App\Object\Base\Users\Roles\IRoleRep.cs =====
using App;
using Domain.Objects.Base;

public interface IRoleRep :  IBaseRep<Role, int> {


}

