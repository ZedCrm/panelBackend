===== FILE: API\Attributes\RequirePermissionAttribute.cs =====
using Microsoft.AspNetCore.Mvc;

namespace API.Attributes
{
    [AttributeUsage(AttributeTargets.Class | AttributeTargets.Method)]
    public class RequirePermissionAttribute : Attribute
    {
        public string Permission { get; }
        public RequirePermissionAttribute(string permission)
        {
            Permission = permission;
        }
    }
}

===== FILE: API\Controllers\bases\AuthController.cs =====
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Threading.Tasks;
using App.Contracts.Object.Base.auth;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using MyFrameWork.AppTool;

namespace API.Controllers.bases
{

    [ApiController]
    [Route("api/[controller]")]
    public class AuthController : ControllerBase
    {
        private readonly IAuthApp _authApp;

        public AuthController(IAuthApp authApp)
        {
            _authApp = authApp;
        }

        [HttpPost("login")]
        public async Task<ActionResult<OPTResult<AuthResponseDto>>> Login([FromBody] LoginRequestDto request)
        {
            var result = await _authApp.LoginAsync(request);
            if (result.IsSucceeded == false)
                return BadRequest(result);

            return Ok(result);
        }

        [HttpPost("register")]
        public async Task<IActionResult> Register(RegisterRequestDto dto)
        {
            var result = await _authApp.RegisterAsync(dto);
            if (result.IsSucceeded == false)
                return BadRequest(result.Message);
            return Ok(result.Data);
        }
    }
}

===== FILE: API\Controllers\bases\UserController.cs =====
using App.Contracts.Object.Base.Users;
using App.Object.Base.Users;
using Microsoft.AspNetCore.Mvc;
using MyFrameWork.AppTool;
using System.Security.Claims;

namespace API.Controllers.bases
{
    [ApiController]
    [Route("api/[controller]")]
    public class UserController : BaseController
    {
        private readonly IUsersApp _usersApp;

        public UserController(IUsersApp usersApp)
        {
            _usersApp = usersApp;
        }

        [HttpPost]
        [Route("/api/User/GetAll")]
        public async Task<ActionResult<OPTResult<UsersView>>> GetAll([FromBody] Pagination pagination)
        {

            
            
            var result = await _usersApp.GetAll(pagination);
            return Ok(result);
        }

        [HttpGet]
        [Route("/api/User/GetById")]
        public async Task<ActionResult<OPTResult<UsersUpdate>>> GetById([FromQuery] int id)
        {
            var result = await _usersApp.GetById(id);
            return Ok(result);
        }

        [HttpPost]
        [Route("/api/User/create")]
        public async Task<ActionResult<OPT>> Create([FromBody] UsersCreat userCreate)
        {
            var result = await _usersApp.Create(userCreate);
            return Ok(result);
        }

        [HttpPost]
        [Route("/api/User/update")]
        public async Task<ActionResult<OPT>> Update([FromBody] UsersUpdate userUpdate)
        {
            var result = await _usersApp.Update(userUpdate);
            return Ok(result);
        }

        [HttpPost]
        [Route("/api/User/delete")]
        public async Task<ActionResult<OPT>> Delete([FromBody] List<int> ids)
        {
            var result = await _usersApp.DeleteBy(ids);
            return Ok(result);
        }

        [HttpGet]
        [Route("/api/User/getcreateform")]
        public async Task<ActionResult<OPTResult<UserCreateFormData>>> GetCreateForm()
        {
            var result = await _usersApp.CreateForm();
            return Ok(result);
        }
    }
}

===== FILE: API\Controllers\Shop\CountTypeController.cs =====
using App.Contracts.Object.Shop.CountTypeCon;
using App.Contracts.Object.Shop.ProductCon;
using Microsoft.AspNetCore.Mvc;
using MyFrameWork.AppTool;

namespace API.Controllers.Shop
{

    public class CountTypeController : BaseController
    {
            private readonly ICountTypeApp countTypeApp;

           public CountTypeController(ICountTypeApp countTypeApp)
        {
            this.countTypeApp = countTypeApp;
        }
       

        [HttpPost]
        [Route("/api/CountType/GetAll")]
        public async Task<ActionResult<OPTResult<CountTypeView>>> Index([FromBody] Pagination pagination)
        {
             return await countTypeApp.GetAll(pagination);

             

            
        }
        [HttpGet]
        [Route("/api/CountType/GetById")]
        public async Task<ActionResult<OPTResult<CountTypeView>>> GetById([FromQuery] int id)
        {
            var result = await countTypeApp.GetById(id);
            if (result.IsSucceeded == true) { return Ok(result); }
            else { return Ok(result); }
        }
        


      


        [HttpPost]
        [Route("/api/CountType/create")]
        public async Task<ActionResult> create([FromBody] CountTypeCreate countTypeCreate)
        {

            var opt = await countTypeApp.Create(countTypeCreate);
            if (opt.IsSucceeded==true) { return Ok(opt); }
            else { return Ok ( opt); }
            

        }
       

        [HttpPost]
        [Route("/api/CountType/delete")]
        public async Task<ActionResult> delete([FromBody] List<int> ids)
        {
            var result = await countTypeApp.DeleteBy(ids); 
            return Ok(result);
        }

        [HttpDelete]
        [Route("/api/CountType/deletebyid")]
        public OkResult deletebyid([FromQuery] int id)
        {
            var ids = new List<int> { id };
            countTypeApp.DeleteBy(ids); // ØªØºÛŒÛŒØ± Ù…ØªØ¯ DeleteBy Ø¨Ø±Ø§ÛŒ Ù¾Ø°ÛŒØ±Ø´ Ù„ÛŒØ³Øª Ø¢ÛŒâ€ŒØ¯ÛŒâ€ŒÙ‡Ø§
            return Ok();
        }


        [HttpPost]
        [Route("/api/CountType/update")]
        public async Task<ActionResult> update([FromBody] CountTypeView countTypeView)
        {
            var opt = await countTypeApp.Update(countTypeView);
            if (opt.IsSucceeded == true) { return Ok(opt); }
            else { return Ok(opt); }  
        }        
        [HttpGet("/api/counttype/CountTypelist")]
        public IActionResult CountTypeList()
        {
            var pagination = new Pagination
            {
                PageNumber = 1,
                PageSize = 1000
            };
            var list = countTypeApp.GetAll(pagination);
            return Ok(list);
        }
       
    }
}


===== FILE: API\Controllers\Shop\InvController.cs =====
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Threading.Tasks;
using API.Attributes;
using App.Contracts.Object.Shop.InvCon;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using MyFrameWork.AppTool;

namespace API.Controllers.Shop
{
    [Route("[controller]")]
    [Authorize]
    public class InvController : BaseController
    {


        private readonly IInvApp invApp;
        private readonly ILogger<InvController> _logger;
        public InvController(IInvApp invApp, ILogger<InvController> logger)
        {
            this.invApp = invApp;
            _logger = logger;

        }



        [HttpPost]
        [Route("/api/inv/GetAll")]
        [RequirePermission("ViewProducs")]
        public async Task<ActionResult<ApiResult<InvView>>> Index([FromBody] Pagination pagination)
        {
            return await invApp.GetAll(pagination);
        }

        [HttpGet]
        [Route("/api/inv/GetById")]
        public async Task<ActionResult<OPTResult<InvUpdate>>> GetById([FromQuery] int id)
        {
            var result = await invApp.GetById(id);
            if (result.IsSucceeded == true) { return Ok(result); }
            else { return Ok(result); }
        }

        [HttpPost]
        [Route("/api/inv/create")]
        public async Task<ActionResult> create([FromBody] InvCreate invCreate)
        {

            var opt = await invApp.Create(invCreate);
            if (opt.IsSucceeded == true) { return Ok(opt); }
            else { return Ok(opt); }


        }

        [HttpPost]
        [Route("/api/inv/delete")]
        public async Task<ActionResult> delete([FromBody] List<int> ids)
        {
            var result = await invApp.DeleteBy(ids);
            return Ok(result);
        }

        [HttpDelete]
        [Route("/api/inv/deletebyid")]
        public OkResult deletebyid([FromQuery] int id)
        {
            var ids = new List<int> { id };
            invApp.DeleteBy(ids); // ØªØºÛŒÛŒØ± Ù…ØªØ¯ DeleteBy Ø¨Ø±Ø§ÛŒ Ù¾Ø°ÛŒØ±Ø´ Ù„ÛŒØ³Øª Ø¢ÛŒâ€ŒØ¯ÛŒâ€ŒÙ‡Ø§
            return Ok();
        }


        [HttpPost]
        [Route("/api/inv/update")]
        public async Task<ActionResult> update([FromBody] InvUpdate invUpdate)
        {
            var opt = await invApp.Update(invUpdate);
            if (opt.IsSucceeded == true) { return Ok(opt); }
            else { return Ok(opt); }  
        }  


    }
}

===== FILE: API\Controllers\Shop\ProductController.cs =====
using API.Attributes;
using App.Contracts.Object.Shop.ProductCon;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using MyFrameWork.AppTool;

namespace API.Controllers.Shop
{
    /// <summary>
    /// کنترلر مربوط به مدیریت محصولات در سیستم
    /// </summary>
    
    [Authorize]
    public class ProductController : BaseController
    {
        private readonly IProductApp _productApp;

        /// <summary>
        /// سازنده کنترلر، تزریق وابستگی IProductApp
        /// </summary>
        /// <param name="productApp">سرویس لایه اپلیکیشن برای مدیریت محصولات</param>
        public ProductController(IProductApp productApp)
        {
            _productApp = productApp;
        }

        /// <summary>
        /// دریافت لیست محصولات با صفحه‌بندی
        /// </summary>
        /// <param name="pagination">اطلاعات صفحه‌بندی</param>
        /// <returns>لیست محصولات یا خطای عدم دسترسی</returns>
        
        [RequirePermission("ViewProduct")]
        [HttpPost]
        [Route("/api/product/GetAll")]
        
        public async Task<ActionResult<OPTResult<ProductView>>> Index([FromBody] Pagination pagination)
        {
           
            // فراخوانی متد GetAll از لایه اپلیکیشن با userId
            return await _productApp.GetAll(pagination);
        }

        /// <summary>
        /// جستجوی محصولات بر اساس معیارهای مشخص
        /// </summary>
        /// <param name="productSearch">معیارهای جستجو</param>
        /// <returns>لیست محصولات فیلترشده</returns>
        [HttpPost]
        [Route("/api/product/search")]
        public async Task<ActionResult<OPTResult<ProductView>>> Search([FromBody] ProductSearchCriteria productSearch)
        {
            return await _productApp.SearchProducts(productSearch);
        }

        /// <summary>
        /// ایجاد محصول جدید
        /// </summary>
        /// <param name="product">اطلاعات محصول جدید</param>
        /// <returns>نتیجه عملیات ایجاد</returns>
        [HttpPost]
        [Route("/api/product/create")]
        public async Task<ActionResult> Create([FromBody] ProductCreate product)
        {
            var opt = await _productApp.Create(product);
            return Ok(opt);
        }

        /// <summary>
        /// حذف محصولات بر اساس لیست آیدی‌ها
        /// </summary>
        /// <param name="ids">لیست آیدی‌های محصولات</param>
        /// <returns>نتیجه عملیات حذف</returns>
        [HttpPost]
        [Route("/api/product/delete")]
        public async Task<OkObjectResult> Delete([FromBody] List<int> ids)
        {
            var opt = await _productApp.DeleteBy(ids);
            return Ok(opt);
        }

        /// <summary>
        /// دریافت اطلاعات یک محصول بر اساس آیدی
        /// </summary>
        /// <param name="id">آیدی محصول</param>
        /// <returns>اطلاعات محصول یا پیام خطا</returns>
        [HttpGet]
        [Route("/api/product/GetById")]
        public async Task<ActionResult<OPTResult<ProductUpdate>>> GetById([FromQuery] int id)
        {
            var result = await _productApp.GetById(id);
            if (result.IsSucceeded)
            {
                return Ok(result);
            }
            return Ok(new { warning = result.Message });
        }

        /// <summary>
        /// به‌روزرسانی اطلاعات محصول
        /// </summary>
        /// <param name="product">اطلاعات به‌روزرسانی‌شده محصول</param>
        /// <returns>نتیجه عملیات به‌روزرسانی</returns>
        [HttpPost]
        [Route("/api/product/update")]
        public async Task<ActionResult> Update([FromBody] ProductView product)
        {
            var opt = await _productApp.Update(product);
            if (opt.IsSucceeded)
            {
                return Ok(opt);
            }
            return Ok(new { warning = opt.Message });
        }
    }
}

===== FILE: API\Controllers\BaseController.cs =====
using Microsoft.AspNetCore.Mvc;

namespace API.Controllers
{

    [ApiController]
    public class BaseController : ControllerBase
    {
    }
}


===== FILE: API\Controllers\MetadataController.cs =====
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Reflection;
using Microsoft.AspNetCore.Mvc;
using MyFrameWork.AppTool;

namespace API.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class MetadataController : ControllerBase
    {
        [HttpGet("GetModelMetadata/{modelName}")]
        public IActionResult GetModelMetadata(string modelName)
        {
            var assembly = Assembly.Load("App.Contracts");

            var type = assembly.GetTypes()
                .FirstOrDefault(t =>
                    t.IsClass &&
                    t.Namespace != null &&
                    t.Namespace.StartsWith("App.Contracts") &&
                    t.Name.Equals(modelName, StringComparison.OrdinalIgnoreCase));

            if (type == null)
                return NotFound($"Model '{modelName}' not found.");

            var propertyMetadata = new List<object>();

            foreach (var prop in type.GetProperties())
            {
                var displayAttr = prop.GetCustomAttribute<DisplayAttribute>();
                var requiredAttr = prop.GetCustomAttribute<RequiredAttribute>();
                var stringLengthAttr = prop.GetCustomAttribute<StringLengthAttribute>();
                var minLengthAttr = prop.GetCustomAttribute<MinLengthAttribute>();
                var maxLengthAttr = prop.GetCustomAttribute<MaxLengthAttribute>();
                var selectSourceAttr = prop.GetCustomAttribute<SelectSourceAttribute>();

                var inputType = prop.PropertyType == typeof(bool) ? "boolean" :
                                prop.PropertyType == typeof(int) || prop.PropertyType == typeof(long) ? "number" :
                                "text";

                var metadata = new
                {
                    name = ToCamelCase(prop.Name),
                    displayName = displayAttr?.Name ?? prop.Name,
                    inputType,
                    controlType = selectSourceAttr != null ? "select" : null,
                    selectSource = selectSourceAttr?.SourceName,
                    required = requiredAttr != null,
                    maxLength = maxLengthAttr?.Length ?? stringLengthAttr?.MaximumLength,
                    minLength = minLengthAttr?.Length ?? stringLengthAttr?.MinimumLength
                };

                propertyMetadata.Add(metadata);
            }

            return Ok(new Dictionary<string, List<object>> { { type.Name, propertyMetadata } });
        }

        private static string ToCamelCase(string input)
        {
            if (string.IsNullOrEmpty(input) || char.IsLower(input[0]))
                return input;

            return char.ToLower(input[0]) + input.Substring(1);
        }
    }
}


===== FILE: API\Middleware\TokenValidationMiddleware.cs =====
using API.Attributes;
using App.Contracts.Object.Base.auth;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging;
using System.Security.Claims;
using System.Threading.Tasks;

namespace API.Middleware
{
    public class TokenValidationMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<TokenValidationMiddleware> _logger;

        public TokenValidationMiddleware(RequestDelegate next, ILogger<TokenValidationMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

  public async Task InvokeAsync(HttpContext context, IPermissionService permissionService)
{
    var endpoint = context.GetEndpoint();
    var authorizeAttribute = endpoint?.Metadata.GetMetadata<Microsoft.AspNetCore.Authorization.AuthorizeAttribute>();

    // Ø§Ú¯Ø± Ø§Ú©Ø´Ù† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù„Ø§Ú¯ÛŒÙ† Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù‡
    if (authorizeAttribute == null)
    {
        await _next(context);
        return;
    }

    // 1. Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
    if (!context.User.Identity?.IsAuthenticated ?? true)
    {
        context.Response.StatusCode = 401;
        await context.Response.WriteAsync("Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²: ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±.");
        return;
    }

    // 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ userId
    var userIdClaim = context.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    if (!int.TryParse(userIdClaim, out int userId))
    {
        context.Response.StatusCode = 401;
        await context.Response.WriteAsync("ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±: Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.");
        return;
    }

    context.Items["UserId"] = userId;

    // 3. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾Ø±Ù…ÛŒØ´Ù† Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø§Ø² Attribute Ø³ÙØ§Ø±Ø´ÛŒ
    var requirePermissionAttribute = endpoint?.Metadata.GetMetadata<RequirePermissionAttribute>();
    if (requirePermissionAttribute != null)
    {
        bool hasPermission = await permissionService.HasPermissionAsync(userId, requirePermissionAttribute.Permission);
        if (!hasPermission)
        {
            context.Response.StatusCode = 403;
            await context.Response.WriteAsync($"Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ù…Ù†ÙˆØ¹: Ø´Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ '{requirePermissionAttribute.Permission}' Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.");
            return;
        }
    }

    await _next(context);
}
    }

    // Extension Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Middleware
    public static class TokenValidationMiddlewareExtensions
    {
        public static IApplicationBuilder UseTokenValidation(this IApplicationBuilder builder)
        {
            return builder.UseMiddleware<TokenValidationMiddleware>();
        }
    }
}


===== FILE: API\Properties\launchSettings.json =====
{
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:49673",
      "sslPort": 44398
    }
  },
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "http://localhost:80",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "https": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "https://localhost:80;http://localhost:80",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "launchUrl": "swagger",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
      
    },
    "Production": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": false,
      "applicationUrl": "http://localhost:80",  
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Production"
      }
    }
  }
}


===== FILE: API\appsettings.Development.json =====
{
  
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}


===== FILE: API\appsettings.json =====
{
    "Kestrel": {
    "Endpoints": {
      "Http": {
        "Url": "http://0.0.0.0:90"
      }
    }
  },
  
  "ConnectionStrings": {
    "DefaultConnection": "Server=.; Database=crm; User Id=sa; Password=Nm123456; Encrypt=True; TrustServerCertificate=True; MultipleActiveResultSets=True;"
  },

  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}


===== FILE: API\Program.cs =====
using ConfApp;
using Infrastructure;
using Infrastructure.data.seed;
using Microsoft.Extensions.Logging;
using Microsoft.AspNetCore.Authentication.JwtBearer; // Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡
using Microsoft.IdentityModel.Tokens; // Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡
using System.Text;
using API.Middleware; // Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll",
        builder =>
        {
            builder.AllowAnyOrigin()
                   .AllowAnyMethod()
                   .AllowAnyHeader();
        });
});

builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// ØªÙ†Ø¸ÛŒÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª JWT
builder.Services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = true,
        ValidateAudience = true,
        ValidateLifetime = true,
        ValidateIssuerSigningKey = true,
        ValidIssuer = "yourapp", // Ø¨Ø§ÛŒØ¯ Ø¨Ø§ "iss" ØªÙˆÚ©Ù† Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
        ValidAudience = "yourapp", // Ø¨Ø§ÛŒØ¯ Ø¨Ø§ "aud" ØªÙˆÚ©Ù† Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
        IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes("your_secret_key_at_least_16_chars")) // Ú©Ù„ÛŒØ¯ Ø§Ù…Ø¶Ø§
    };
});

if (false)
{
    CRMBootstraper.AddCRMManagement(builder.Services, "Data Source=dev.db", DbProvider.Sqlite);
}
else
{
    var connectionString = builder.Configuration.GetConnectionString("DefaultConnection");
    CRMBootstraper.AddCRMManagement(builder.Services, connectionString, DbProvider.SqlServer);
}

var app = builder.Build();

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseRouting();

// Middleware Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
app.Use(async (context, next) =>
{
    var logger = context.RequestServices.GetRequiredService<ILogger<Program>>();
    logger.LogInformation("Received {Method} request at {Url}", context.Request.Method, context.Request.Path);
    await next();
    logger.LogInformation("Response Status Code: {StatusCode}", context.Response.StatusCode);
});

// Middleware Ø¨Ø±Ø§ÛŒ Ù‡Ù†Ø¯Ù„ Ú©Ø±Ø¯Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Preflight (OPTIONS)
app.Use(async (context, next) =>
{
    if (context.Request.Method == "OPTIONS")
    {
        context.Response.StatusCode = 200;
        await context.Response.CompleteAsync();
        return;
    }
    await next();
});

app.UseCors("AllowAll");

app.UseAuthentication(); 
app.UseTokenValidation();
app.UseAuthorization();

builder.Services.AddHttpContextAccessor();
//app.UseHttpsRedirection();

app.MapControllers();

using (var scope = app.Services.CreateScope())
{
    var context = scope.ServiceProvider.GetRequiredService<MyContext>();
    var seeder = new DatabaseSeeder(context);
    seeder.SeedAll();
}

app.Run();

===== FILE: API\test.js =====


===== FILE: App\Object\Base\auth\UserContext\UserContext.cs =====

using System.Security.Claims;
using Microsoft.AspNetCore.Http;
using App.Contracts.Object.Base.auth.UserContext;

namespace App.Object.Base.auth.UserContext
{
    public class UserContext : IUserContext
    {
        private readonly IHttpContextAccessor _httpContextAccessor;

        public UserContext(IHttpContextAccessor httpContextAccessor)
        {
            _httpContextAccessor = httpContextAccessor;
        }

        public int? GetUserId()
        {
            if (_httpContextAccessor.HttpContext?.Items.TryGetValue("UserId", out var userIdObj) == true && userIdObj is int userId)
            {
                return userId;
 
            }
            return null;
        }

        public bool IsAuthenticated()
        {
            return _httpContextAccessor.HttpContext?.User.Identity?.IsAuthenticated ?? false;
        }
    }
}

===== FILE: App\Object\Base\auth\AuthApp.cs =====
using App.Contracts.Object.Base.auth;
using Domain.Objects.Base;
using MyFrameWork.AppTool;

namespace App.Object.Base.Auth
{

    public class AuthApp : IAuthApp
    {
        private readonly IUserRepository _userRepository;
        private readonly ITokenApp _tokenService;

        public AuthApp(IUserRepository userRepository, ITokenApp tokenService)
        {
            _userRepository = userRepository;
            _tokenService = tokenService;
        }

      public async Task<OPTResult<AuthResponseDto>> LoginAsync(LoginRequestDto request)
{
    var user = await _userRepository.GetByEmailAsync(request.Email);
    if (user == null)
        return OPTResult<AuthResponseDto>.Failed("Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯.");

    var isPasswordCorrect = BCrypt.Net.BCrypt.Verify(request.Password, user.PasswordHash);
    if (!isPasswordCorrect)
        return OPTResult<AuthResponseDto>.Failed("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.");

    var token = _tokenService.GenerateToken(user);

    return OPTResult<AuthResponseDto>.Success(new AuthResponseDto
    {   UserId = user.Id,
        Email = user.Email,
        FullName = user.FullName,
        Token = token
    });
}

      public async Task<OPTResult<AuthResponseDto>> RegisterAsync(RegisterRequestDto request)
{
    if (await _userRepository.ExistsByEmailAsync(request.Email))
        return OPTResult<AuthResponseDto>.Failed("Ø§ÛŒÙ…ÛŒÙ„ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª.");

    var user = new User
    {
        FullName = request.FullName,
        Email = request.Email,
        PasswordHash = BCrypt.Net.BCrypt.HashPassword(request.Password)
    };

    await _userRepository.AddAsync(user);
    var token = _tokenService.GenerateToken(user);

    return OPTResult<AuthResponseDto>.Success(new AuthResponseDto
    {
        Email = user.Email,
        FullName = user.FullName,
        Token = token
    });
}
    }
    public interface IUserRepository
    {
        Task<User?> GetByEmailAsync(string email);
        Task AddAsync(User user);
        Task<bool> ExistsByEmailAsync(string email);
    }

}

===== FILE: App\Object\Base\auth\IPermissionRep.cs =====
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace App.Object.Base.auth
{
    public interface IPermissionRep 
    {
        Task<bool> HasPermissionAsync(int userId, string permission);
    }
}

===== FILE: App\Object\Base\auth\PermissionService.cs =====
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using App.Contracts.Object.Base.auth;

namespace App.Object.Base.auth
{
    public class PermissionService :IPermissionService
    {
       private readonly IPermissionRep _permissionRep;

        public PermissionService (IPermissionRep permissionRep)
        {
            _permissionRep = permissionRep;
        }

        public async Task<bool> HasPermissionAsync(int userId, string permission)
        {
            return await _permissionRep.HasPermissionAsync(userId, permission);
        }
    }
}

===== FILE: App\Object\Base\auth\TokenApp.cs =====

using App.Contracts.Object.Base.auth;
using Domain.Objects.Base;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

namespace App.Object.Base.auth
{
    public class TokenApp : ITokenApp
    {




        public string GenerateToken(User user)
        {
            var claims = new[]
            {
        new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),
        new Claim(ClaimTypes.Email, user.Email),
        new Claim(ClaimTypes.Name, user.FullName)
    };

            // ðŸ”’ Ù‡Ø§Ø±Ø¯Ú©Ø¯ Ù…ÙˆÙ‚ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø¶Ø§
            var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes("your_secret_key_at_least_16_chars")); // Ø§ÛŒÙ†Ùˆ Ø¨Ø¹Ø¯Ø§Ù‹ Ù…ÛŒâ€ŒØ¨Ø±ÛŒ ØªÙˆÛŒ appsettings
            var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

            var token = new JwtSecurityToken(
                issuer: "yourapp",
                audience: "yourapp",
                claims: claims,
                expires: DateTime.Now.AddHours(1),
                signingCredentials: creds
            );

            return new JwtSecurityTokenHandler().WriteToken(token);
        }
    }
}

===== FILE: App\Object\Base\Users\Roles\IRoleRep.cs =====
using App;
using Domain.Objects.Base;

public interface IRoleRep :  IBaseRep<Role, int> {


}

===== FILE: App\Object\Base\Users\UsersApp.cs =====
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using App.Contracts.Object.Base.auth;
using App.Contracts.Object.Base.Users;
using App.Object.Base.Auth;
using App.utility;
using AutoMapper;
using Domain.Objects.Base;
using MyFrameWork.AppTool;

namespace App.Object.Base.Users
{
    public class UsersApp : IUsersApp
    {


        #region constructor
        private readonly IMyUserRepository _userRepository;
        private readonly IMapper _mapper;
        private readonly IPermissionService _PermissionService;
        private readonly IRoleRep _roleRep;

        public UsersApp(IMyUserRepository userRepository, IMapper mapper, IPermissionService permissionService, IRoleRep roleRep)
        {
            _roleRep = roleRep;
            _userRepository = userRepository;
            _mapper = mapper;
            _PermissionService = permissionService;
        }
        #endregion






        public async Task<OPT> Create(UsersCreat objectCreate)
        {
            var validateAllProperties = ModelValidator.ValidateToOpt<UsersCreat>(objectCreate);
            if (!validateAllProperties.IsSucceeded) return validateAllProperties;

            // Ú†Ú© Ú©Ø±Ø¯Ù† Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒÚ©ØªØ§
            var uniqueOpt = await ValidationUtility.ValidateUniqueAsync<User, int>(
                _userRepository,
                c => c.Email == objectCreate.Email,
                MessageApp.DuplicateField(objectCreate.Email)
            );
            if (!uniqueOpt.IsSucceeded) return uniqueOpt;

            uniqueOpt = await ValidationUtility.ValidateUniqueAsync<User, int>(
                _userRepository,
                c => c.Username == objectCreate.Username,
                MessageApp.DuplicateField(objectCreate.Username)
            );
            if (!uniqueOpt.IsSucceeded) return uniqueOpt;

            var user = _mapper.Map<User>(objectCreate);
            user.UserRoles = objectCreate.RoleIds.Select(roleId => new UserRole { RoleId = roleId }).ToList();
            await _userRepository.CreateAsync(user);
            await _userRepository.SaveChangesAsync();

            var opt = new OPT();
            return opt.Succeeded(MessageApp.CustomAddsuccses(objectCreate.Username));
        }




        public async Task<OPTResult<UserCreateFormData>> CreateForm()
        {
            var roles = await _roleRep.GetAsync();
            var createForm = new UserCreateFormData
            {
                Roles = roles.Select(role => new RoleView
                {
                    Id = role.Id,
                    Name = role.Name
                }).ToList()
            };



            return OPTResult<UserCreateFormData>.Success(createForm, MessageApp.AcceptOpt);
        }

        public async Task<OPT> DeleteBy(List<int> objectids)
        {


            var opt = new OPT();
            try
            {
                if (objectids == null || !objectids.Any())
                {
                    opt.Failed(MessageApp.NotFound);
                    return opt;
                }
                foreach (var productid in objectids)
                    _userRepository.DeleteById(productid);

                await _userRepository.SaveChangesAsync();
                opt.Succeeded(MessageApp.CustomSuccess("Ø­Ø°Ù"));
            }
            catch (Exception ex)
            {
                opt.Failed(MessageApp.CustomDeleteFail(ex.Message));
            }

            return opt;
        }





        public async Task<OPTResult<UsersView>> GetAll(Pagination pagination)
        {



            var data = await _userRepository.GetAsync();

            var users = _mapper.Map<List<UsersView>>(data);



            // ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§  
            var totalRecords = await _userRepository.CountAsync();



            // ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ ØµÙØ­Ø§Øª  
            var totalPages = pagination.CalculateTotalPages(totalRecords);

            // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ØªÛŒØ¬Ù‡  
            return new OPTResult<UsersView>
            {
                IsSucceeded = true,
                Message = MessageApp.AcceptOpt,
                Data = users,
                TotalRecords = totalRecords,
                TotalPages = totalPages,
                PageNumber = pagination.PageNumber,
                PageSize = pagination.PageSize
            };



        }

        public async Task<OPTResult<UsersUpdate>> GetById(int id)
        {
            var user = await _userRepository.GetAsync(id);
            if (user == null) { return new OPTResult<UsersUpdate> { IsSucceeded = false, Message = MessageApp.NotFound }; }
            var userCreat = _mapper.Map<UsersUpdate>(user);
            
            return OPTResult<UsersUpdate>.Success(userCreat, MessageApp.AcceptOpt);
        }




   public async Task<OPT> Update(UsersUpdate objectView)
{
    var validateAllProperties = ModelValidator.ValidateToOpt<UsersUpdate>(objectView);
    if (!validateAllProperties.IsSucceeded) return validateAllProperties;

    var uniqueOpt = await ValidationUtility.ValidateUniqueAsync<User, int>(
        _userRepository,
        c => c.Email == objectView.Email && c.Id != objectView.Id,
        MessageApp.DuplicateField(objectView.Email)
    );
    if (!uniqueOpt.IsSucceeded) return uniqueOpt;

    uniqueOpt = await ValidationUtility.ValidateUniqueAsync<User, int>(
        _userRepository,
        c => c.Username == objectView.Username && c.Id != objectView.Id,
        MessageApp.DuplicateField(objectView.Username)
    );
    if (!uniqueOpt.IsSucceeded) return uniqueOpt;

    var user = await _userRepository.GetAsync(objectView.Id);
    if (user == null) return new OPT().Failed(MessageApp.NotFound);

    user.Username = objectView.Username;
    user.Email = objectView.Email;
    user.FullName = objectView.FullName;
    // ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Password Ø®Ø§Ù„ÛŒ Ù†Ø¨Ø§Ø´Ø¯ØŒ PasswordHash Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†
    if (!string.IsNullOrEmpty(objectView.Password))
    {
        user.PasswordHash = BCrypt.Net.BCrypt.HashPassword(objectView.Password);
    }
    user.UserRoles = objectView.RoleIds.Select(roleId => new UserRole { RoleId = roleId, UserId = objectView.Id }).ToList();

    await _userRepository.UpdateAsync(user);
    await _userRepository.SaveChangesAsync();
    return new OPT().Succeeded(MessageApp.AcceptOpt);
}


    }


    public interface IMyUserRepository : IBaseRep<User, int>
    {

    }
}



===== FILE: App\Object\Base\IPersonRep.cs =====
using Domain.Objects.Base;

namespace App.Object.Base
{
    public interface IPersonRep : IBaseRep<Person, int>
    {

    }
}


===== FILE: App\Object\Base\PersonApp.cs =====
using App.Contracts.Object.Base;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace App.Object.Base
{
    public class PersonApp : IPersonApp
    {
        private readonly IPersonRep _ctx;
        public PersonApp(IPersonRep personRep)
        {
            _ctx = personRep;
        }
        public async Task<List<PersonView>> personViews()
        {
            var persons = await _ctx.GetAsync();

            return  persons.Select(c => new PersonView
            {
                Id = c.Id,
                Name = c.Name,
                Family = c.Family,
                age = c.Age,

            }).ToList();

        }

        public Task<List<PersonView>> PersonViews()
        {
            throw new NotImplementedException();
        }
    }
}


===== FILE: App\Object\Shop\CountTypeApp\ContTypeApp.cs =====
// ÙØ§ÛŒÙ„: App/Object/Shop/CountTypeApp/CountTypeApp.cs
using App.Contracts.Object.Shop.CountTypeCon;
using App.utility;
using AutoMapper;
using Domain.Objects.Shop;
using MyFrameWork.AppTool;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace App.Object.Shop.CountTypeApp
{
    public class CountTypeApp : ICountTypeApp
    {
        private readonly ICountTypeRep _rep;
        private readonly IMapper _mapper;

        public CountTypeApp(ICountTypeRep rep, IMapper mapper)
        {
            _rep = rep;
            _mapper = mapper;
        }






        // Ù…ØªØ¯ Ø¯Ø±ÛŒØ§ÙØª Ù‡Ù…Ù‡ ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ø´Ù…Ø§Ø±Ø´ Ø¨Ø§ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ
        public async Task<OPTResult<CountTypeView>> GetAll(Pagination pagination)
        {
            
            var entities = await _rep.GetAsync(pagination);
            var viewModels = _mapper.Map<List<CountTypeView>>(entities);
            var totalRecords = await _rep.CountAsync();

            return new OPTResult<CountTypeView>
            {
                IsSucceeded = true,
                Message = MessageApp.AcceptOpt,
                Data = viewModels,
                PageNumber = pagination.PageNumber,
                PageSize = pagination.PageSize,
                TotalRecords = totalRecords,
                TotalPages = pagination.CalculateTotalPages(totalRecords)
            };
        }




        // Ù…ØªØ¯ Ø¯Ø±ÛŒØ§ÙØª ÛŒÚ© ÙˆØ§Ø­Ø¯ Ø´Ù…Ø§Ø±Ø´ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ù†Ø§Ø³Ù‡
        public async Task<OPTResult<CountTypeView>> GetById(int id)
        {
            var entity = await _rep.GetAsync(id);
            if (entity == null)
                return OPTResult<CountTypeView>.Failed(MessageApp.NotFound);

            var viewModel = _mapper.Map<CountTypeView>(entity);
            return OPTResult<CountTypeView>.Success(viewModel,MessageApp.AcceptOpt);
        }




        // Ù…ØªØ¯ Ø§ÛŒØ¬Ø§Ø¯ ÙˆØ§Ø­Ø¯ Ø´Ù…Ø§Ø±Ø´ Ø¬Ø¯ÛŒØ¯
        public async Task<OPTResult<CountTypeView>> Create(CountTypeCreate countTypeCreate)
        {
            var entity = _mapper.Map<CountType>(countTypeCreate);
            await _rep.CreateAsync(entity);
            await _rep.SaveChangesAsync();

            var viewModel = _mapper.Map<CountTypeView>(entity);
            return OPTResult<CountTypeView>.Success(viewModel, MessageApp.AcceptOpt);
        }





        // Ù…ØªØ¯ Ø­Ø°Ù ÙˆØ§Ø­Ø¯ Ø´Ù…Ø§Ø±Ø´ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù„ÛŒØ³Øª Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§

        public async Task<OPTResult<CountTypeView>> DeleteBy(List<int> ids)
        {
            var entities = await _rep.GetByIdsAsync(ids);
            if (entities == null || entities.Count == 0)
                return OPTResult<CountTypeView>.Failed(MessageApp.NotFound);

            var deletableEntities = new List<CountType>();
            var usedEntities = new List<CountType>();

            foreach (var entity in entities)
            {
                var isUsed = await _rep.HasRelationsAsync(entity); // âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ø¬Ø¯Ø§ÙˆÙ„ Ø±Ø§Ø¨Ø·Ù‡â€ŒØ§ÛŒ
                if (!isUsed)
                    deletableEntities.Add(entity);
                else
                    usedEntities.Add(entity);
            }

            if (deletableEntities.Any())
            {
                _rep.DeleteRange(deletableEntities);
                await _rep.SaveChangesAsync();
            }

            string message = "";
            if (deletableEntities.Count > 0)
                message += $"{deletableEntities.Count} ÙˆØ§Ø­Ø¯ Ø´Ù…Ø§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯. ";
            if (usedEntities.Count > 0)
                message += $"{usedEntities.Count} Ù…ÙˆØ±Ø¯ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ø­Ø°Ù Ù†Ø´Ø¯.";

            return OPTResult<CountTypeView>.Success(message.Trim());
        }




        // Ù…ØªØ¯ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ§Ø­Ø¯ Ø´Ù…Ø§Ø±Ø´ (Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²)
        public async Task<OPTResult<CountTypeView>> Update(CountTypeView countTypeView)
        {
            var validateAllProperties = ModelValidator.ValidateToOptResult<CountTypeView>(countTypeView);
            if (!validateAllProperties.IsSucceeded) return validateAllProperties;


            var entity = await _rep.GetAsync(countTypeView.Id);
            if (entity == null)
                return OPTResult<CountTypeView>.Failed(MessageApp.NotFound);
            _mapper.Map(countTypeView, entity);
            await _rep.UpdateAsync(entity);
            await _rep.SaveChangesAsync();
            var viewModel = _mapper.Map<CountTypeView>(entity);
            return OPTResult<CountTypeView>.Success(viewModel, MessageApp.AcceptOpt);
        }
    }

    // Ø§ÛŒÙ†ØªØ±ÙÛŒØ³ Ø±ÛŒÙ¾ÙˆØ²ÛŒØªÙˆØ±ÛŒ ÙˆØ§Ø­Ø¯ Ø´Ù…Ø§Ø±Ø´ Ú©Ù‡ Ø§Ø² Ø±ÛŒÙ¾ÙˆØ²ÛŒØªÙˆØ±ÛŒ Ù¾Ø§ÛŒÙ‡ Ø§Ø±Ø«â€ŒØ¨Ø±ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    public interface ICountTypeRep : IBaseRep<CountType, int> { }



}

